<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>2.4.2 Creating, Setting, and Registering the Primary Server Instance</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Cluster Operation Guide(Database Multiplexing)</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="b1440-00-02-00-00.html">Chapter&nbsp;2 Setting Up Database Multiplexing Mode</a> &gt; <a href="b1440-00-02-04-00.html">2.4 Setting Up the Primary Server</a> &gt; 2.4.2 Creating, Setting, and Registering the Primary Server Instance</div><div class="back_next"><a href="b1440-00-02-04-01.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1440-00-02-04-03.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h3 id="mID_060302">2.4.2 Creating, Setting, and Registering the Primary Server Instance<a name="N39G"></a></h3><div class="body"><div class="textblock"><p>This section explains how to create, set, and register the primary server instance.</p><div class="note"><p class="title">Note</p><div class="notebody"><ul><li><p>Mirroring Controller supports instances that are registered in the Windows service.</p></li></ul></div></div><div class="ref"><p class="title">See</p><div class="refbody"><ul><li><p>Refer to "Client Authentication" in the PostgreSQL Documentation for information on the pg_hba.conf file.</p></li><li><p>Refer to "<a href="b1440-a-01-00.html">A.1 Parameters Set on the Primary Server</a>" for information on the postgresql.conf file.</p></li><li><p>Refer to "mc_ctl" in Reference for information on the command.</p></li></ul></div></div><p>Perform the following procedure:</p><ol><li><p>Refer to "Setup" in the Installation and Setup Guide for Server, and then perform the FUJITSU Enterprise Postgres setup and create the FUJITSU Enterprise Postgres instance.</p><ul><li><p>Use ASCII characters in the data storage destination directory.</p></li><li><p>When registering an instance to the Windows service, perform the settings required to enable Mirroring Controller to start and stop the instance. Execute the pg_ctl command with the following specified for the register mode:</p><ul><li><p>For the service name of the -N option, specify the name set for the db_instance_service_name parameter in the server definition file</p></li><li><p>Specify "demand" for the -S option, so that the service does not start automatically on startup of the system</p></li></ul></li></ul><div class="note"><p class="title">Note</p><div class="notebody"><ul><li><p>If degradation starts occurring due to an error during operations in database multiplexing mode, recovery is required for the standby server. There are some conditions to execute the pg_rewind command to recover the standby server. One of the conditions can be satisfied by enabling checksums when executing the initdb command. This is not mandatory. Refer to "<a href="b1440-00-04-01-01.html#mID_0801010103">4.1.1.1.3 Identify cause of error and perform recovery</a>" for details.</p></li><li><p>Do not configure the Windows service of a multiplexed instance to perform automatic start, as it is started by Mirroring Controller.</p></li></ul></div></div></li><li><p>When using transparent data encryption, configure the encryption settings for the storage data.</p><p>Create the keystore file.</p><p>Refer to "Database Multiplexing Mode" in the Operation Guide for details, and then configure the settings.</p></li><li><p>Add the following entry to the pg_hba.conf file to authenticate connections from the standby server.</p><p>Copy the file to the standby server later.</p><pre class="border"># TYPE    DATABASE        USER        ADDRESS                       METHOD  host    replication     fsep       <span class="i">standbyServerAddress</span>       <span class="i">authenticationMethod</span>  host    replication     fsep       <span class="i">primaryServerAddress</span>       <span class="i">authenticationMethod</span></pre><p>For the primary and standby server addresses, specify the IP address that will connect to the log transfer network.</p><p>Additionally, all servers can be used as the primary server or the standby server, so add entries for the addresses of all servers that comprise the database multiplexing system.</p><div class="point"><p class="title">Point</p><div class="pointbody"><p><span class="em">Setting a</span><span class="em">n authentication</span><span class="em"> method other than trust authentication</span></p><p>If the primary server becomes the standby server, to perform automatic authentication of connections to the primary server, create a password file (%APPDATA%\postgresql\pgpass.conf), and then specify a password for the replication database. Accordingly, the instance administrator operating system user and the user registered in the database will be the same, so you can verify that the connection was not made by an unspecified user. Additionally, the password that was set beforehand will be used in the authentication, so that the connection will be automatic.</p></div></div><div class="note"><p class="title">Note</p><div class="notebody"><p>If trust authentication is set, all OS users who can log in to the primary server will be able to connect, and if one of these is a malicious user, then that user can corrupt the standby server data, or cause the job system to fail, by sending an erroneous transaction log. Therefore, decide on the authentication method according to the security requirements of the system using database multiplexing mode.</p><p>Refer to "Authentication Methods" in the PostgreSQL Documentation for details on the authentication methods that can be set.</p></div></div></li><li><p>Configure this setting to enable the instance administrator user of the primary server to connect as a database application.</p><p>This setting enables the connection to the instance using the user name of the instance administrator user, so that Mirroring Controller can monitor instance errors. Configure this setting to enable the connection to the postgres database.</p><ul><li><p>If password authentication is used</p><p>In the db_instance_password parameter of the <span class="i">serverIdentifier</span>.conf file, specify the password for the instance administrator user. This password is used to connect to the database instance. If a password is not specified in the db_instance_password parameter, the connection to the database instance from Mirroring Controller will fail, and it will not be possible to perform the process monitoring of the instance.</p></li><li><p>If password authentication is not used</p><p>There is no need to specify the password in the db_instance_password parameter.</p><p>Even if the password for the instance administrator user is specified in the db_instance_password parameter, it will be ignored.</p></li><li><p>If certificate authentication using SSL is used</p><p>Specify connection parameters for SSL in the db_instance_ext_ pq_conninfo parameter and db_instance_ext_jdbc_conninfo parameter in the <span class="i">serverIdentifier</span>.conf file. If the pasrameters are not specified, the connection to the database instance from Mirroring Controller will fail, and it will not be possible to perform the process monitoring of the instance. If certificate authentication using SSL is not performed, the parameters specification is not required.</p></li></ul><p>An example of setting the authentication method is shown below.</p><pre class="border"># TYPE    DATABASE        USER        ADDRESS        METHOD  host    postgres        fsep        127.0.0.1/32   <span class="i">authenticationMethod</span></pre><div class="note"><p class="title">Note</p><div class="notebody"><p>Mirroring Controller uses the PostgreSQL JDBC 4.2 driver to connect to the database instance. Therefore, for the authentication method, specify a method supported by the JDBC driver. If an authentication method not supported by the JDBC driver is specified, Mirroring Controller will fail to start. Refer to the PostgreSQL JDBC Driver Documentation for information on authentication methods supported by the JDBC driver.</p></div></div></li><li><p>To use database multiplexing mode, specify the parameters shown in the table below in the postgresql.conf file.</p><p>The postgresql.conf file is copied when the standby server instance is created. Accordingly, set the required parameters in the standby server.</p><p>To use database multiplexing mode, specify the parameters shown in the table below in the postgresql.conf file. After editing the postgresql.conf file, restart the instance.</p><table><caption>Table&nbsp;2.4 Parameters</caption><col><col><col><col><col><tr><th colspan="2" valign="top"><p>Parameter</p></th><th valign="top"><p>Content specified</p></th><th colspan="2" valign="top"><p>Remarks</p></th></tr><tr><td colspan="2" align="left" valign="top"><p>wal_level</p></td><td align="left" valign="top"><p>replica or logical</p></td><td colspan="2" align="left" valign="top"><p>Specify "logical" when logical decoding is also to be used.</p></td></tr><tr><td colspan="2" align="left" valign="top"><p>max_wal_senders</p></td><td align="left" valign="top"><p>2 or more</p></td><td colspan="2" align="left" valign="top"><p>Specify "2" when building a Mirroring Controller cluster system.</p><p>When additionally connecting asynchronous standby servers to the cluster system, add the number of simultaneous connections from these standby servers.</p></td></tr><tr><td colspan="2" align="left" valign="top"><p>synchronous_standby_names</p></td><td align="left" valign="top"><p>'<span class="i">standbyServerName</span>'</p></td><td colspan="2" align="left" valign="top"><p>Specify the name that will identify the standby server.</p><p>Enclose the name in single quotation marks (').</p><p>Do not change this parameter while Mirroring Controller is running.</p><p>Do not specify multiple names to this parameter as the Mirroring Controller can manage only one standby server.</p></td></tr><tr><td colspan="2" align="left" valign="top"><p>hot_standby</p></td><td align="left" valign="top"><p>on</p></td><td colspan="2" align="left" valign="top"><p>Specify this to execute reference jobs on the standby server.</p></td></tr><tr><td colspan="2" align="left" valign="top"><p>wal_keep_size</p></td><td align="left" valign="top"><p>WAL save size (megabytes)</p></td><td colspan="2" align="left" valign="top"><p>If a delay exceeding the value set in this parameter occurs, the WAL segment required later by the primary server may be deleted.</p><p>Additionally, if you stop a standby server (for maintenance, for example), consider the stop time and set a value that will not cause the WAL segment to be deleted.</p><p>Refer to "Estimating Transaction Log Space Requirements" in the Installation and Setup Guide for Server for information on estimating the WAL save size.</p></td></tr><tr><td colspan="2" align="left" valign="top"><p>wal_log_hints</p></td><td align="left" valign="top"><p>on</p></td><td colspan="2" align="left" valign="top"><p>When using the pg_rewind command to recover a standby server, specify this parameter or enable checksums when executing the initdb command.</p></td></tr><tr><td colspan="2" align="left" valign="top"><p>wal_sender_timeout</p></td><td align="left" valign="top"><p>Timeout (milliseconds)</p></td><td colspan="2" align="left" valign="top"><p>Specify the time period after which it is determined that an error has occurred in the transaction log transfer on the primary server.</p><p>By aligning this value with the value for the database process heartbeat monitoring time, you can unify the time after which it is determined that an error has occurred.</p></td></tr><tr><td colspan="2" align="left" valign="top"><p>archive_mode</p></td><td align="left" valign="top"><p>on</p></td><td colspan="2" align="left" valign="top"><p>Specify the archive log mode.</p></td></tr><tr><td colspan="2" align="left" valign="top"><p>archive_command</p></td><td align="left" valign="top"><p>'cmd /c ""installDir\\bin\\pgx_walcopy.cmd" "%p" "backupDataStorageDestinationDir\\archived_wal\\%f""'</p></td><td colspan="2" align="left" valign="top"><p>Specify the command and storage destination to save the transaction log.</p></td></tr><tr><td colspan="2" align="left" valign="top"><p>backup_destination</p></td><td align="left" valign="top"><p>Backup data storage destination directory</p></td><td colspan="2" align="left" valign="top"><p>Specify the name of directory where to store the backup data.</p><p>Set the permissions so that only the instance administrator user can access the specified directory.</p><p>Specify the same full path on all servers, so that the backup data of other servers can be used to perform recovery.</p></td></tr><tr><td colspan="2" align="left" valign="top"><p>max_connections</p></td><td align="left" valign="top"><p>Number of simultaneous client connections to the instance + superuser_reserved_connections</p></td><td colspan="2" align="left" valign="top"><p>The value specified is also used to restrict the number of connections from client applications and the number of connections for the management of instances.</p><p>Refer to "When an Instance was Created with the initdb Command" in the Installation and Setup Guide for Server, and "Connections and Authentication" in the PostgreSQL Documentation, for details.</p></td></tr><tr><td colspan="2" align="left" valign="top"><p>superuser_reserved_connections</p></td><td align="left" valign="top"><p>Add the number of simultaneous executions of mc_ctl status <span class="inline-note">*1</span> + 2</p></td><td colspan="2" align="left" valign="top"><p>Specify the number of connections reserved for connections from database superusers.</p><p>Add the number of connections from Mirroring Controller processes. Also reflect the added value in the max_connections parameter.</p></td></tr><tr><td colspan="2" align="left" valign="top"><p>wal_receiver_timeout</p></td><td align="left" valign="top"><p>Timeout (milliseconds)</p></td><td colspan="2" align="left" valign="top"><p>Specify the time period after which it is determined that an error has occurred when the transaction log was received on the standby server.</p><p>By aligning this value with the value for the heartbeat monitoring time of the database process, you can unify the time after which it is determined that an error has occurred.</p></td></tr><tr><td colspan="2" align="left" valign="top"><p>restart_after_crash</p></td><td align="left" valign="top"><p>off</p></td><td colspan="2" align="left" valign="top"><p>If "on" is specified, or the default value is used for this parameter, behavior equivalent to restarting FUJITSU Enterprise Postgres, including crash recovery, will be performed when some server processes end abnormally.</p><p>However, when database multiplexing monitoring is used, a failover will occur after an error is detected when some server processes end abnormally, and the restart of those server processes is forcibly stopped. Specify "off" to prevent behavior such as this from occurring for no apparent reason.</p></td></tr><tr><td colspan="2" align="left" valign="top"><p>synchronous_commit</p></td><td align="left" valign="top"><p>on or remote_apply</p></td><td colspan="2" align="left" valign="top"><p>Specify up to what position WAL send is to be performed before transaction commit processing returns a normal termination response to a client.</p><p>The recommended value is on or remote_apply to prevent data loss caused by operating system or server down immediately after a switch or switch.</p></td></tr><tr><td align="left" valign="top"><p>recovery_target_timeline</p></td><td colspan="2" align="left" valign="top"><p>latest</p></td><td align="left" valign="top"><p>Specify "latest" so that the new standby server (original primary server) will follow the new primary server when a switch occurs.</p><p>This parameter is required when the original primary server is incorporated as a new standby server after the primary server is switched.</p></td></tr></table><p class="supple">*1: Number of simultaneous executions of the mc_ctl command in the status mode.</p></li></ol><p></p></div></div><div class="header_footer"><div class="back_next"><a href="b1440-00-02-04-01.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1440-00-02-04-03.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2016-2021 FUJITSU LIMITED</div></div></body></html>