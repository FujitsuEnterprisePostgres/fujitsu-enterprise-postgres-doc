<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>2.4.1 Setting Up Database Multiplexing Mode on the Primary Server</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Cluster Operation Guide(Database Multiplexing)</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="b1440-00-02-00-00.html">Chapter&nbsp;2 Setting Up Database Multiplexing Mode</a> &gt; <a href="b1440-00-02-04-00.html">2.4 Setting Up the Primary Server</a> &gt; 2.4.1 Setting Up Database Multiplexing Mode on the Primary Server</div><div class="back_next"><a href="b1440-00-02-04-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1440-00-02-04-02.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h3 id="mID_060301">2.4.1 Setting Up Database Multiplexing Mode on the Primary Server<a name="N38G"></a></h3><div class="body"><div class="textblock"><p>This section explains how to set up database multiplexing mode on the primary server.</p><p>In database multiplexing, the files that are required for operations are managed in the Mirroring Controller management directory.</p><p>There is one Mirroring Controller management directory for each instance.</p><div class="note"><p class="title">Note</p><div class="notebody"><ul><li><p>Do not place the Mirroring Controller management directory in a directory managed by FUJITSU Enterprise Postgres, otherwise it may be deleted by mistake with the directories managed by FUJITSU Enterprise Postgres, and an old version of files may be restored.</p></li></ul></div></div><div class="ref"><p class="title">See</p><div class="refbody"><ul><li><p>Refer to "Preparing Directories for Resource Deployment" in the Installation and Setup Guide for Server for details on the directories that are managed by FUJITSU Enterprise Postgres.</p></li><li><p>Refer to "mc_ctl" in Reference for information on the command.</p></li><li><p>Refer to "<a href="b1440-a-00-00.html">Appendix&nbsp;A Parameters</a>" for details on each parameter to be edited for the setup.</p></li></ul></div></div><p>Perform the following procedure:</p><ol><li><p>Log in to the primary server.</p></li><li><p>Create the Mirroring Controller management directory that will store the files required by database multiplexing.</p><p>Use ASCII characters in the Mirroring Controller management directory.</p><p>Additionally, grant "Write" permission to the instance administrator user for the Mirroring Controller management directory.</p></li><li><p>In the network configuration file (network.conf), define the network configuration that will link between the Mirroring Controller processes.</p><p>Create the network.conf file in the Mirroring Controller management directory, based on the sample file.</p><pre>Sample file</pre><pre class="border"><span class="i">installDir</span>\share\mc_network.conf.sample</pre><p>In network.conf, specify the IP address or host name and port number of the primary server and standby server, and define the network configuration that will link between the Mirroring Controller processes, and between Mirroring Controller processes and the Mirroring Controller arbitration process.</p><p>Refer to "<a href="b1440-a-03-00.html">A.3 Network Configuration File</a>" for details.</p><p>A definition example is shown below.</p><p>The content to be defined depends on the operation settings at the time a heartbeat abnormality is detected.</p><dl><dt class="em">When automatic degradation by the arbitration server is selected</dt><dd><pre>Example)The IDs of the primary server and standby server are set to "server1" and "server2", and their port numbers are set to "27540" and "27541". The ID of the server of the Mirroring Controller arbitration process is set to "arbiter", and its port number is set to "27541".</pre><pre class="border">server1 192.0.2.100,192.0.3.100 27540,27541 serverserver2 192.0.2.110,192.0.3.110 27540,27541 serverarbiter 192.0.3.120 27541 arbiter</pre><p>Ensure that the port numbers set for the primary server, standby server, and arbitration server do not conflict with other software. In addition, when the arbitration server is used for automatic degradation, use a network in which the arbitration network is not affected by a line failure in the admin network.</p><p>When the server type is "server", two IP addresses or host names, and two port numbers need to be specified in the following order:</p><ul><li><p>IP address or host name of the database server used as the admin network</p></li><li><p>IP address or host name of the database server used as the arbitration network</p></li><li><p>Port number of the database server used as the admin network</p></li><li><p>Port number of the database server used as the arbitration network</p></li></ul><p>If the server type is "arbiter", specify the IP address or host name set for the my_address parameter and the port number set for the port parameter in arbitration.conf of the arbitration server.</p></dd></dl><dl><dt class="em">When operation other than automatic degradation by the arbitration server is selected</dt><dd><pre>Example)The IDs of the servers are set to "server1" and "server2", and their port numbers are set to "27540".</pre><pre class="border">server1 192.0.2.100 27540server2 192.0.2.110 27540</pre></dd></dl><p>Ensure that the port numbers for the primary and standby server do not conflict with other software.</p><p>Register the port number of the primary server in the services file, because there are programs, such as WebAdmin, that search an available port number using the services file.</p><p>Register any name as the service name.</p></li><li><p>Change the access permissions for the network.conf file.</p><p>For network.conf, set read and write permissions for the instance administrator user only.</p><p>If users other than the instance administrator user are granted access permissions, the mc_ctl command will not work. Accordingly, users other than the instance administrator user are prevented from operating Mirroring Controller.</p><pre>Example)The following is an execution example, in which the instance administrator user is granted full access permissions as the owner when the operating system user name of the instance administrator user is "fsepuser". The following procedure applies when the user is logged in to the Windows server as "fsepuser":</pre><pre class="border">&gt; takeown /f network.conf&gt; icacls network.conf /reset&gt; icacls network.conf /inheritance:r&gt; icacls network.conf /grant fsepuser:F</pre></li><li><p>Define the information related to Mirroring Controller monitoring and control in the <span class="i">serverIdentifier</span>.conf file.</p><p>Create the <span class="i">serverIdentifier</span>.conf file in the Mirroring Controller management directory, based on the sample file.</p><p>As the file name for the <span class="i">serverIdentifier</span>.conf file, use the server identifier name that was specified in the network.conf file in step 3.</p><pre>Sample file</pre><pre class="border"><span class="i">installDir</span>\share\mc_server.conf.sample</pre><p>Set the parameters shown in the table below in the <span class="i">serverIdentifier</span>.conf file.</p><table><caption>Table&nbsp;2.3 Parameters</caption><col><col><col><tr><th valign="top"><p>Parameter</p></th><th valign="top"><p>Content specified</p></th><th valign="top"><p>Remarks</p></th></tr><tr><td align="left" valign="top"><p>db_instance</p></td><td align="left" valign="top"><p>'<span class="i">dataStorageDestinationDir'</span></p></td><td align="left" valign="top"><p>Use ASCII characters, and specify "\\" as the path delimiter.</p><p>Enclose the parameter value in single quotation marks (').</p></td></tr><tr><td align="left" valign="top"><p>db_instance_service_name</p></td><td align="left" valign="top"><p>'<span class="i">registeredServiceNameOf</span><span class="i">FujitsuEnterprisePostgres</span><span class="i">Instance</span>'</p></td><td align="left" valign="top"><p>Specify the registered service name of the FUJITSU Enterprise Postgres instance in the Windows service.</p><p>Use ASCII characters, enclosed in single quotation marks (').</p></td></tr><tr><td align="left" valign="top"><p>db_instance_password</p></td><td align="left" valign="top"><p><span class="i">'passwordOfInstanceAdminUser</span>'</p></td><td align="left" valign="top"><p>If password authentication is performed, specify this parameter in the settings used when Mirroring Controller connects to a database instance.</p><p>Use ASCII characters, enclosed in single quotation marks (').</p><p>If the specified value of this parameter includes ' or \, write \' or \\, respectively.</p></td></tr><tr><td align="left" valign="top"><p>enable_hash_in_password</p></td><td align="left" valign="top"><p>on or off</p></td><td align="left" valign="top"><p>Specify on to treat the # in the db_instance_password specification as a password character, or off to treat it as a comment.</p><p>The default is "off".</p></td></tr><tr><td align="left" valign="top"><p>mc_service_name</p></td><td align="left" valign="top"><p>'<span class="i">registeredServiceNameOfMirroringController</span>'</p></td><td align="left" valign="top"><p>Specify the Mirroring Controller service name registered in the Windows service. Use ASCII characters excluding forward slash (/) and backslash (\) to specify this parameter.</p><p>The service name is up to 124 bytes.</p></td></tr><tr><td align="left" valign="top"><p>event_source</p></td><td align="left" valign="top"><p>'<span class="i">eventSourceName</span>'</p></td><td align="left" valign="top"><p>Specify the event source name to be used to identify the Mirroring Controller message in the event log. Use ASCII characters to specify this parameter.</p><p>The maximum length of the event source name is 255 bytes.</p><p>By using a similar event source name as the postgresql.conf file parameter, the Mirroring Controller output content can be referenced transparently, so log reference is easy.</p></td></tr><tr><td align="left" valign="top"><p>remote_call_timeout</p></td><td align="left" valign="top"><p>Admin communication timeout</p></td><td align="left" valign="top"><p>Specify the timeout value (milliseconds) of the Mirroring Controller agent process for communication between servers. </p><p>Specify a value that is less than the operation system TCP connection timeout.</p></td></tr><tr><td align="left" valign="top"><p>heartbeat_error_action</p></td><td align="left" valign="top"><p>Operation when a heartbeat abnormality is detected using operating system or server heartbeat monitoring</p></td><td align="left" valign="top"><p>arbitration: Perform automatic degradation using the arbitration server.</p><p>command: Call a user exit to determine degradation, and perform automatic degradation if required.</p><p>message: Notify messages.</p><p>fallback: Perform automatic degradation unconditionally.</p><p>Set the same value on the primary server and standby server.</p></td></tr><tr><td align="left" valign="top"><p>heartbeat_interval</p></td><td align="left" valign="top"><p>Interval time for abnormality monitoring during heartbeat monitoring of the operating system or server (milliseconds)</p></td><td rowspan="3" align="left" valign="top"><p>Abnormality monitoring of the operating system or server is performed at the interval (milliseconds) specified in heartbeat_interval.</p><p>This parameter setting is used as the default for database process heartbeat monitoring, streaming replication abnormality monitoring, and disk abnormality monitoring.</p><p>When setting the monitoring time, there are some considerations to take into account to optimize degradation using abnormality monitoring. Refer to "<a href="b1440-00-02-11-04.html#mID_06110401">2.11.4.1 Tuning for Abnormality Monitoring of the Operating System or Server</a>" for details.</p></td></tr><tr><td align="left" valign="top"><p>heartbeat_timeout</p></td><td align="left" valign="top"><p>Timeout for abnormality monitoring during heartbeat monitoring of the operating system or server (seconds)</p></td></tr><tr><td align="left" valign="top"><p>heartbeat_retry</p></td><td align="left" valign="top"><p>Number of retries for abnormality monitoring during heartbeat monitoring of the operating system or server (number of times)</p></td></tr><tr><td align="left" valign="top"><p>fencing_command</p></td><td align="left" valign="top"><p>'<span class="i">fencingCmdFilePath</span>'</p><p>[Setting example]</p><p>fencing_command = 'c:\\mc\\fencing_dir\\execute_fencing.bat'</p></td><td align="left" valign="top"><p>Specify the full path of the fencing command that fences a database server where an error is determined to have occurred.</p><p>Enclose the path in single quotation marks (').</p><p>Any multibyte characters must use the same encoding as the operating system.</p><p>This parameter must be specified when "command" is set for heartbeat_error_action.</p><p>Specify the path using less than 260 bytes.</p></td></tr><tr><td align="left" valign="top"><p>fencing_command_timeout</p></td><td align="left" valign="top"><p>Fencing command timeout (seconds)</p></td><td align="left" valign="top"><p>If the command does not respond within the specified number of seconds, fencing is determined to have failed and a signal (SIGTERM) is sent to the fencing command execution process.</p><p>Specify a value between 1 and 2147483647.</p><p>The default is 20 seconds.</p></td></tr><tr><td align="left" valign="top"><p>arbitration_timeout</p></td><td align="left" valign="top"><p>Timeout for arbitration processing in the Mirroring Controller arbitration process (seconds)</p></td><td align="left" valign="top"><p>The specified value must be at least equal to the heartbeat monitoring time of the operating system or server + fencing_command_timeout in the arbitration configuration file.</p><p>If there is no response for at least the number of seconds specified, the primary server will not be switched and the standby server will not be disconnected. Therefore, perform degradation manually.</p><p>Specify a value between 1 and 2147483647.</p><p>This parameter does not need to be set for operation that does not use the arbitration server.</p></td></tr><tr><td align="left" valign="top"><p>arbitration_command</p></td><td align="left" valign="top"><p>'<span class="i">ArbitrationCmd</span><span class="i">FilePath</span>'</p><p>[Setting example]</p><p>arbitration_command = 'c:\\mc\\arbitration_dir\\execute_arbitration_command.bat'</p></td><td align="left" valign="top"><p>Specify the full path of the arbitration command to be executed when an abnormality is detected during heartbeat monitoring of the operating system or server.</p><p>Enclose the path in single quotation marks (').</p><p>Any multibyte characters must use the same encoding as the operating system.</p><p>This parameter must be specified when "command" is set for heartbeat_error_action.</p><p>Specify the path using less than 260 bytes.</p></td></tr><tr><td align="left" valign="top"><p>arbitration_command_timeout</p></td><td align="left" valign="top"><p>Timeout for arbitration command (seconds)</p></td><td align="left" valign="top"><p>If the command does not respond within the specified number of seconds, it is determined that execution of the arbitration command has failed and a signal (SIGTERM) is sent to the arbitration command execution process.</p><p>Specify a value between 1 and 2147483647.</p><p>This parameter can be specified only when "command" is set for heartbeat_error_action.</p></td></tr></table><div class="tips"><p class="title">Information</p><div class="tipsbody"><p>Refer to "<a href="b1440-a-04-01.html">A.4.1 Server Configuration File for the Database Servers</a>" for information on the parameters and for other parameters.</p></div></div></li><li><p>Change the access permissions for the <span class="i">serverIdentifier</span>.conf file.</p><p>For <span class="i">serverIdentifier</span>.conf, set read and write permissions for the instance administrator user only. If users other than the instance administrator user are granted access permissions, the mc_ctl command will not work.</p><pre>Example)The following is an execution example, in which the instance administrator user is granted full access permissions when the operating system user name of the instance administrator user is "fsepuser". The following procedure applies when the user is logged in to the Windows server as "fsepuser":</pre><pre class="border">&gt; takeown /f <span class="i">serverIdentifier</span>.conf&gt; icacls <span class="i">serverIdentifier</span>.conf /reset&gt; icacls <span class="i">serverIdentifier</span>.conf /inheritance:r&gt; icacls <span class="i">serverIdentifier</span>.conf /grant fsepuser:F</pre></li><li><p>Configure the Windows firewall.</p><p>If the Windows firewall feature is to be enabled, you should enable the port number of Mirroring Controller that you specified in the network definition file in step 3. Refer to "<a href="b1440-e-02-00.html">E.2 Windows Firewall Settings</a>" for details.</p></li><li><p>Register Mirroring Controller to the Windows service.</p><p>Execute the mc_ctl command in the register mode.</p><p>For the -P option of the mc_ctl command, specify the password of the operating system user who executes the command.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl register -M D:\mcdir\inst1 -P ********</pre><div class="note"><p class="title">Note</p><div class="notebody"><p>When specifying the password in the -P option of the mc_ctl command, for security reasons, you should be careful not to allow other users to access it.</p></div></div><div class="tips"><p class="title">Information</p><div class="tipsbody"><p>You can use the mc_ctl command with the -S option to specify automatic start and stop of Mirroring Controller. Refer to "<a href="b1440-00-02-12-00.html">2.12 Setting Automatic Start and Stop of Mirroring Controller and Multiplexed Instances</a>" for details.</p></div></div><p>Using the service name specified in the mc_service_name parameter of <span class="i">serverIdentifier</span>.conf in step 5, Mirroring Controller is registered to the Windows service.</p><p>You can execute the sc qc command to check the registration status.</p></li></ol><p></p></div></div><div class="header_footer"><div class="back_next"><a href="b1440-00-02-04-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1440-00-02-04-02.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2016-2021 FUJITSU LIMITED</div></div></body></html>