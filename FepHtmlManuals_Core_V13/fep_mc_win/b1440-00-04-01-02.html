<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>4.1.2 Operations when the Server has Started Degrading after a Disconnection has Occurred</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Cluster Operation Guide(Database Multiplexing)</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="b1440-00-04-00-00.html">Chapter&nbsp;4 Action Required when an Error Occurs in Database Multiplexing Mode</a> &gt; <a href="b1440-00-04-01-00.html">4.1 Action Required when Server Degradation Occurs</a> &gt; 4.1.2 Operations when the Server has Started Degrading after a Disconnection has Occurred</div><div class="back_next"><a href="b1440-00-04-01-01.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1440-00-04-01-03.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h3 id="mID_080102">4.1.2 Operations when the Server has Started Degrading after a Disconnection has Occurred<a name="N96G"></a></h3><div class="body"><div class="textblock"><p>This section explains the operations when the server has started degrading after a disconnection has occurred.</p><div class="note"><p class="title">Note</p><div class="notebody"><p>After a disconnection has occurred as a result of an abnormality on the standby server, the database will not have a multiplexed configuration until the standby server is rebuilt. Remove the cause of the error as quickly as possible, and then rebuild the standby server.</p></div></div><p>If the disconnection occurred and the server has started degrading, perform the following operations to recover the standby server and revert it to its original state:</p><ul><li><p><a href="b1440-00-04-01-02.html#mID_08010201"><span class="u">Identify Cause of Error and </span><span class="u">Re</span><span class="u">store</span><span class="u"> the Standby Server</span></a></p></li><li><p><a href="b1440-00-04-01-02.html#mID_08010202"><span class="u">Rebuild the Standby Server</span></a></p></li></ul><p>The flow of these operations is shown in the figure below.</p><p class="caption">Figure&nbsp;4.2 Flow of operations</p><p><img src="clust08img/e-0803-ope.gif" alt="" width="682" height="621"></p><p></p></div></div><h4 id="mID_08010201">4.1.2.1 Identify Cause of Error and Restore the Standby Server<a name="N97G"></a></h4><div class="body"><div class="textblock"><p>Perform the recovery according to the following procedure:</p><ol><li><p><a href="b1440-00-04-01-02.html#mID_0801020101"><span class="u">Stop Mirroring Controller</span></a></p></li><li><p><a href="b1440-00-04-01-02.html#mID_0801020102"><span class="u">Recovery of the Mirroring Controller management directory</span></a></p></li><li><p><a href="b1440-00-04-01-02.html#mID_0801020103"><span class="u">Identify cause of error and perform recovery</span></a></p></li></ol></div></div><h5 id="mID_0801020101">4.1.2.1.1 Stop Mirroring Controller<a name="N98G"></a></h5><div class="body"><div class="textblock"><p>Execute the mc_ctl command in stop mode for the standby server on which the error occurred.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl stop -M D:\mcdir\inst1</pre><p>This also stops the instance that is required to perform the recovery.</p><div class="note"><p class="title">Note</p><div class="notebody"><p>If the instance does not stop, refer to "Actions in Response to Failure to Stop an Instance" in the Operation Guide, and then stop the instance.</p><p>Then, specify the -e option in the above command to forcibly stop Mirroring Controller.</p></div></div></div></div><h5 id="mID_0801020102">4.1.2.1.2 Recovery of the Mirroring Controller management directory<a name="N99G"></a></h5><div class="body"><div class="textblock"><p>Copy the files in the Mirroring Controller management directory from the backup data, and then perform the recovery.</p></div></div><h5 id="mID_0801020103">4.1.2.1.3 Identify cause of error and perform recovery<a name="N100G"></a></h5><div class="body"><div class="textblock"><p>Refer to the event log of the primary server and the standby server to identify the cause of the error, and then perform recovery.</p><p>Execute the pg_basebackup command to perform recovery by synchronizing data in the primary server with the standby server.</p><pre>Example)</pre><pre class="border">&gt; pg_basebackup -D D:\database\inst1 -X fetch --waldir=E:\transaction\inst1 --progress --verbose -R --dbname="application_name=<span class="i">standbyServerName</span>" -h <span class="i">primaryServerHostName</span> -p <span class="i">primaryServerPortNumber</span></pre><div class="ref"><p class="title">See</p><div class="refbody"><p>This recovery procedure is the same as the procedure for setting up the standby server.</p><p>Refer to "<a href="b1440-00-02-05-02.html">2.5.2 Creating, Setting, and Registering the Standby Server Instance</a>", and then perform the recovery.</p></div></div></div></div><h4 id="mID_08010202">4.1.2.2 Rebuild the Standby Server<a name="N101G"></a></h4><div class="body"><div class="textblock"><p>Start the Mirroring Controller and the instance of the standby server, and rebuild the standby server.</p><dl><dt class="em">Enabling automatic switch/disconnection</dt><dd><p>As the instance administrator user, execute the mc_ctl command in start mode.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl start -M D:\mcdir\inst1</pre></dd></dl><dl><dt class="em">Disabling automatic switch/disconnection</dt><dd><p>As the instance administrator user, execute the mc_ctl command in start mode with the -F option specified.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl start -M D:\mcdir\inst1 -F</pre></dd></dl><div class="point"><p class="title">Point</p><div class="pointbody"><p>After Mirroring Controller is started, automatic switch/disconnection can be enabled or disabled using the enable-failover or disable-failover mode of the mc_ctl command.</p></div></div></div></div><div class="header_footer"><div class="back_next"><a href="b1440-00-04-01-01.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1440-00-04-01-03.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2016-2021 FUJITSU LIMITED</div></div></body></html>