<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>3.9.3 Changing from Database Multiplexing Mode to Single Server Mode</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Cluster Operation Guide(Database Multiplexing)</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="b1440-00-03-00-00.html">Chapter&nbsp;3 Operations in Database Multiplexing Mode</a> &gt; <a href="b1440-00-03-09-00.html">3.9 Changes in Operation </a> &gt; 3.9.3 Changing from Database Multiplexing Mode to Single Server Mode</div><div class="back_next"><a href="b1440-00-03-09-02.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1440-00-03-09-04.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h3 id="mID_070703">3.9.3 Changing from Database Multiplexing Mode to Single Server Mode<a name="N83G"></a></h3><div class="body"><div class="textblock"><p>The procedure for stopping database multiplexing mode and changing to single server mode is explained below.</p><p>Some tasks must be performed on the database server, and others must be performed on the arbitration server.</p><p>The tasks on the arbitration server are required only if the arbitration server is used for automatic degradation.</p><p></p></div><p class="subhead_1" id="IDclust07N21"><span class="em">Tasks on the database server</span></p><div class="textblock"><ol><li><p>Determine the server for which the instance is to be stopped, and switch this server</p><p>Determine the server that is to be excluded as the database multiplexing mode target, and for which the instance is to be stopped.</p><p>If the server for which the instance is to be stopped is the primary server, execute the mc_ctl command in the switch mode to switch the standby server to the primary server.</p><p>The standby server after the switch is complete will be the server for which the instance is to be stopped.</p><p>If the server for which the instance is to be stopped is the standby server, there is no need to perform the switch operation.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl switch -M D:\mcdir\inst1</pre></li><li><p>Stop Mirroring Controller and the instance.</p><p>On the server that was determined in step 1, execute the mc_ctl command in the stop mode to stop Mirroring Controller and the instance.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl stop -M D:\mcdir\inst1</pre></li><li><p>Unregister Mirroring Controller from the Windows service.</p><p>Execute the mc_ctl command in unregister mode to unregister Mirroring Controller from the Windows service.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl unregister -M D:\mcdir\inst1</pre></li><li><p>Delete registries related to the event log</p><p>If error logs are output to the event log in "<a href="b1440-00-02-02-01.html#mID_060202_w2">2.2.1.2 Preparatory Tasks for the Output of Error Logs to the Event Log</a>", delete the registered event source name for each instance.</p><pre>Example)</pre><pre class="border">&gt; regsvr32 /u /i:"Mirroring Controller inst1" "c:\Program Files\Fujitsu\fsepv&lt;<span class="i">x</span>&gt;server64\lib\mcevent.dll"</pre><pre>Note that "&lt;<span class="i">x</span>&gt;" indicates the product version.</pre></li><li><p>Delete the file resources</p><p>Delete the following file resources:</p><ul><li><p>Data storage destination directory</p></li><li><p>Mirroring Controller management directory</p><pre>Example)</pre><pre class="border">&gt; rmdir /S /Q D:\database\inst1&gt; rmdir /S /Q D:\mcdir\inst1</pre></li></ul><div class="ref"><p class="title">See</p><div class="refbody"><p>Refer "Security-Related Notes" in the Operation Guide for information on deleting the data securely.</p></div></div></li><li><p>Stop the application jobs</p><p>Stop the application jobs to be connected to the primary server.</p></li><li><p>Stop Mirroring Controller and the instance on the primary server</p><p>Execute the mc_ctl command in stop mode on the primary server. </p><pre>Example)</pre><pre class="border">&gt; mc_ctl stop -M D:\mcdir\inst1</pre></li><li><p>Unregister Mirroring Controller from the Windows service on the primary server</p><p>Execute the mc_ctl command in unregister mode to unregister Mirroring Controller from the Windows service.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl unregister -M D:\mcdir\inst1</pre></li><li><p>Delete registries related to the event log on the primary server</p><p>If error logs are output to the event log in "<a href="b1440-00-02-02-01.html#mID_060202_w2">2.2.1.2 Preparatory Tasks for the Output of Error Logs to the Event Log</a>", delete the registered event source name for each instance.</p><pre>Example)</pre><pre class="border">&gt; regsvr32 /u /i:"Mirroring Controller inst1" "c:\Program Files\Fujitsu\fsepv&lt;<span class="i">x</span>&gt;server64\lib\mcevent.dll"</pre><pre>Note that "&lt;<span class="i">x</span>&gt;" indicates the product version.</pre></li><li><p>Delete the database multiplexing mode settings that were configured for the primary server instance.</p><p>Reset the postgresql.conf file parameters to their values before the database multiplexing operation was set.</p><p>Delete the file resources from the Mirroring Controller management directory.</p><p>If the backup operation was performed, delete the following resources:</p><ul><li><p>Mirroring Controller management directory backup data obtained in database multiplexing mode</p></li><li><p>Instance backup data obtained in database multiplexing mode</p></li></ul><p>Additionally, if the primary_conninfo parameter is set in the postgresql.auto.conf file, execute the ALTER SYSTEM RESET statement to delete the setting.</p><pre>Example)An example execution of the psql command is shown below.</pre><pre class="border">postgres=# ALTER SYSTEM RESET primary_conninfo;</pre><p>After these actions are performed, ensure that the backup data is collected when starting the single operation.</p><div class="ref"><p class="title">See</p><div class="refbody"><ul><li><p>Refer to "Security-Related Notes" in the Operation Guide for details on deleting the data securely.</p></li><li><p>Refer to "<a href="b1440-00-02-14-00.html">2.14 Backup Operation</a>" for details on the backup operation.</p></li><li><p>Refer to "<a href="b1440-a-00-00.html">Appendix&nbsp;A Parameters</a>" for details on the postgresql.conf file parameters.</p></li></ul></div></div><div class="point"><p class="title">Point</p><div class="pointbody"><p>In the above procedure, if the postgresql.conf file of the single primary server can be changed by reloading the file, the operation mode can be changed without stopping the application job.</p><p>In that case, execute the mc_ctl command in stop mode with the --mc-only option specified to stop only Mirroring Controller in relation to stopping the primary server.</p></div></div></li></ol></div><p class="subhead_1" id="IDclust07N22"><span class="em">Tasks on the arbitration server</span></p><div class="textblock"><dl><dd></dd></dl><dl><dt class="em">Linux</dt><dd></dd></dl><ol><li><p>Execute the mc_arb command in stop mode to stop the Mirroring Controller arbitration process.</p><pre>Example)</pre><pre class="border">$ mc_arb stop -M /mcarb_dir/arbiter1</pre></li><li><p>Delete the Mirroring Controller arbitration process management directory.</p><pre>Example)</pre><pre class="border">$ rm -rf /mcarb_dir/arbiter1</pre></li></ol><dl><dt class="em">Windows</dt><dd></dd></dl><ol><li><p>Execute the mc_arb command in stop mode to stop the Mirroring Controller arbitration process.</p><pre>Example)</pre><pre class="border">&gt; mc_arb stop -M D:\mcarb_dir\arbiter1</pre></li><li><p>Unregister the Mirroring Controller arbitration process from the Windows service.</p><p>Execute the mc_arb command in unregister mode to unregister the Mirroring Controller arbitration process from the Windows service.</p><pre>Example)</pre><pre class="border">&gt; mc_arb unregister -M D:\mcarb_dir\arbiter1</pre></li><li><p>Delete registrations related to the event log</p><p>If error logs are output to the event log in "<a href="b1440-00-02-02-02.html#mID_06020201">2.2.2.1 Preparing to Output Error Logs to the Event Log (Windows)</a>", delete the registered event source name for each instance.</p><pre>Example)</pre><pre class="border">&gt; regsvr32 /u /i:"Mirroring Controller arbtier1" "c:\Program Files\Fujitsu\fsepv&lt;<span class="i">x</span>&gt;assistant64\lib\mcarbevent.dll"</pre><pre>Note that "&lt;<span class="i">x</span>&gt;" indicates the product version.</pre></li><li><p>Delete the Mirroring Controller arbitration process management directory.</p><pre>Example)</pre><pre class="border">&gt; rmdir /S /Q D:\mcarb_dir\arbiter1</pre></li></ol></div></div><div class="header_footer"><div class="back_next"><a href="b1440-00-03-09-02.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1440-00-03-09-04.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2016-2021 FUJITSU LIMITED</div></div></body></html>