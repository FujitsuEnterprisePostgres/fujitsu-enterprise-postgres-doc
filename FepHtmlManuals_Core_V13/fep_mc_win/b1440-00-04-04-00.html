<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>4.4 Action Required when All Database Servers or Instances Stopped</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Cluster Operation Guide(Database Multiplexing)</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="b1440-00-04-00-00.html">Chapter&nbsp;4 Action Required when an Error Occurs in Database Multiplexing Mode</a> &gt; 4.4 Action Required when All Database Servers or Instances Stopped</div><div class="back_next"><a href="b1440-00-04-03-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1440-00-04-05-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h2 id="mID_0804">4.4 Action Required when All Database Servers or Instances Stopped<a name="N105G"></a></h2><div class="body"><div class="textblock"><p>This section explains what happens when all database servers or instances on the database server have stopped, so jobs cannot continue.</p><div class="ref"><p class="title">See</p><div class="refbody"><p><span class="em">Recovery to database multiplexing mode</span></p><p>Refer to "<a href="b1440-00-04-01-01.html#mID_08010102">4.1.1.2 Rebuild the Standby Server</a>" and "<a href="b1440-00-04-01-01.html#mID_08010103">4.1.1.3 Failback of the Primary Server</a>" for information on recovery to database multiplexing mode.</p></div></div><p></p></div><p class="subhead_1" id="IDclust08N3"><span class="em"></span><span class="em">Overview of recovery operations</span></p><div class="textblock"><p>After recovering the database to the state immediately prior to the failure on a specific server comprising the database multiplexing system, restore the system.</p><p>In other words, after specifying the server on which the database is to be recovered and then recovering it as the new primary server, configure all other servers as new standby servers.</p><p>The flow of these recovery operations is shown in the figure below.</p><p class="caption">Figure&nbsp;4.3 Flow of recovery operations</p><p><img src="clust08img/e-0804-ope-sw.gif" alt="" width="720" height="960"></p><p>Perform the following procedure.</p><ol><li><p>Stop applications</p><p>Stop running applications.</p></li><li><p>Stop Mirroring Controller</p><p>Execute the mc_ctl command in stop mode on all servers that comprise the database multiplexing system.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl stop -M D:\mcdir\inst1</pre><div class="note"><p class="title">Note</p><div class="notebody"><p><span class="em">Forcibly stop Mirroring Controller</span></p><p>If Mirroring Controller does not stop, execute the mc_ctl command in stop mode with the -e option specified.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl stop -M D:\mcdir\inst1 -e</pre></div></div></li><li><p>Perform prerequisite tasks before recovering the database</p><p>First, refer to "Actions when an Error Occurs" in the Operation Guide, and then identify the cause of the error and perform recovery of the disk on which the failure occurred, etc.</p></li><li><p>Identify the new primary server</p><p>Perform the following operations on all servers comprising the database multiplexing system, and check the server containing the backup data that shows the latest date. This server will become the new primary server, on which the database is to be recovered.</p><pre>Example)In the example below, the pgx_rcvall command is executed with the -l option specified and the backup data that shows the latest date is identified.</pre><pre class="border">&gt; pgx_rcvall -l -D D:\database\inst1Date                    Status         Dir2013-07-01 13:30:40     COMPLETE       E:/backup/inst1/2013-07-01_13-30-40</pre></li><li><p>Recover the database on the new primary server</p><p>Recover the database using the recovery method that uses the pgx_rcvall command based on the backup data.</p><ol class="alpha"><li><p>Perform the following operations on all servers comprising the database multiplexing system, and check the server containing the archive log and mirrored transaction log that show the latest date.</p><pre>Example)In the example below, the archive log and mirrored transaction log that show the latest date are identified.</pre><pre class="border">&gt; dir /OD &lt;<span class="i">backupDataStorageDir</span>&gt;\*_wal</pre></li><li><p>If the server containing the latest archive log and mirrored transaction log is different to the new primary server identified in step 4, all files and directories under the directory shown below are copied and written to the backup storage destination directory on the new primary server.</p><pre>Deployment destination directory of the archive log and mirrored transaction log</pre><pre class="border">&lt;<span class="i">backupDataStorageDir</span>&gt;\*_wal</pre></li><li><p>Execute the pgx_rcvall command on the new primary server, specifying the backup storage destination directory of the new primary server.</p><pre>Example)In the example below, the pgx_rcvall command is executed with the -B option specified.</pre><pre class="border">&gt; pgx_rcvall -B E:\backup\inst1 -D D:\database\inst1</pre></li></ol><div class="ref"><p class="title">See</p><div class="refbody"><p>Refer to "Actions when an Error Occurs" in the Operation Guide for information on the pgx_rcvall command.</p></div></div></li><li><p>Recover the Mirroring Controller management directory</p><p>Copy the files in the Mirroring Controller management directory from the backup data on the new primary server, and then perform the recovery.</p></li><li><p>Start the instance and Mirroring Controller</p><p>Start the instance and Mirroring Controller on the new primary server.</p><dl><dt class="em">Enabling automatic switch/disconnection</dt><dd><p>As the instance administrator user, execute the mc_ctl command in start mode.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl start -M D:\mcdir\inst1</pre></dd></dl><dl><dt class="em">Disabling automatic switch/disconnection</dt><dd><p>As the instance administrator user, execute the mc_ctl command in start mode with the -F option specified.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl start -M D:\mcdir\inst1 -F</pre><div class="point"><p class="title">Point</p><div class="pointbody"><p>After Mirroring Controller is started, automatic switch/disconnection can be enabled or disabled using the enable-failover or disable-failover mode of the mc_ctl command.</p></div></div></dd></dl></li><li><p>Resume applications</p><p>Resume execution of applications.</p></li><li><p>Build the new standby server</p><p>Refer to "<a href="b1440-00-02-05-00.html">2.5 Setting Up the Standby Server</a>" for information on building (setting up) a standby server from the primary server.</p><div class="point"><p class="title">Point</p><div class="pointbody"><p>It is not necessary to repeat steps that have already been performed, such as registering to Windows services.</p></div></div></li></ol></div></div><div class="header_footer"><div class="back_next"><a href="b1440-00-04-03-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1440-00-04-05-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2016-2021 FUJITSU LIMITED</div></div></body></html>