<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>3.8.1 Rolling Updates</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Cluster Operation Guide(Database Multiplexing)</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="b1440-00-03-00-00.html">Chapter&nbsp;3 Operations in Database Multiplexing Mode</a> &gt; <a href="b1440-00-03-08-00.html">3.8 Server Maintenance</a> &gt; 3.8.1 Rolling Updates</div><div class="back_next"><a href="b1440-00-03-08-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1440-00-03-08-02.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h3 id="mID_070601">3.8.1 Rolling Updates<a name="N77G"></a></h3><div class="body"><div class="textblock"><p>In database multiplexing mode, rolling updates, that perform the maintenance for the servers that comprise the cluster system, can be performed while jobs continue.</p><p>First, perform the maintenance for the standby server, and then switch the standby server to the primary server. Then, perform the maintenance for the original primary server that was switched to the standby server. This enables maintenance to be performed while jobs continue.</p><p>Note that arbitration server maintenance can be performed without affecting database server operation, so it is not necessary to consider rolling update.</p><div class="ref"><p class="title">See</p><div class="refbody"><p>If the downtime due to the maintenance of the standby server is expected to be long, refer to "Standby server downtime" in "<a href="b1440-00-03-09-01.html">3.9.1 Changes Required when the Standby Server is Stopped</a>".</p></div></div><p>The flow of a rolling update is shown below.</p><p class="caption">Figure&nbsp;3.1 Performing a Rolling Update</p><p><img src="clust07img/e-070301-rud1.gif" alt="" width="536" height="716"></p><p>Perform the following procedure as shown in the above figure:</p><p></p></div><p class="subhead_1" id="IDclust07N12"><span class="em">Standby server maintenance tasks</span></p><div class="textblock"><ol><li><p>To perform the maintenance on the standby server, stop Mirroring Controller.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl stop -M D:\mcdir\inst1</pre></li><li><p>Ensure that Mirroring Controller has completely stopped.</p><p>If the multiplexed instances and Mirroring Controller have been configured on the standby server to start and stop automatically when the operating system of the database server is started or stopped, cancel the setting to start and stop automatically.</p><div class="ref"><p class="title">See</p><div class="refbody"><p>Refer to "<a href="b1440-00-02-12-00.html">2.12 Setting Automatic Start and Stop of Mirroring Controller and Multiplexed Instances</a>" for information on how to configure the multiplexed instances and Mirroring Controller to start and stop automatically when the operating system of the database server start and stops.</p></div></div><p>This task should be performed by the instance administrator user with administrator privileges.</p><p>Use the sc config command to disable automatic start of multiplexed instances and Mirroring Controller from the Windows service.</p><pre>Example)The following is an example using the registered service name "Mirroring_Controller_inst1".</pre><pre class="border">&gt; sc config "Mirroring_Controller_inst1" start= demand</pre><div class="tips"><p class="title">Information</p><div class="tipsbody"><p>You can use the sc qc command to check the registration status.<br>Refer to documentation such as Windows Help and Support for the sc command for information on registry content.</p></div></div></li><li><p>Perform maintenance tasks.</p></li><li><p>Create a copy of the primary server instance on the standby server.</p><p>Execute the pg_basebackup command to create data in the standby server by synchronizing with the primary server.</p><pre>Example)</pre><pre class="border">&gt; pg_basebackup -D D:\database\inst1 -X fetch --waldir=E:\transaction\inst1 --progress --verbose -R --dbname="application_name=<span class="i">standbyServerName</span>" -h <span class="i">primaryServerHostName</span> -p <span class="i">primaryServerPortNumber</span></pre><div class="ref"><p class="title">See</p><div class="refbody"><p>The procedure for copying the primary server instance to the standby server is the same as the procedure for setting up the standby server.</p><p>Refer to "<a href="b1440-00-02-05-02.html">2.5.2 Creating, Setting, and Registering the Standby Server Instance</a>", and then perform the recovery.</p></div></div></li><li><p>Check the settings for automatic start and stop of the multiplexed instances and Mirroring Controller.</p><p>If the multiplexed instances and Mirroring Controller were configured in step 2 to not start and stop automatically when the operating system of the database server starts and stops, then change the settings back. This step can be skipped if automatic start and stop are not required.</p><p>This task should be performed by an instance administrator user with administrator privileges.</p><p>Use the sc config command to enable automatic start of multiplexed instances and Mirroring Controller from the Windows service.</p><pre>Example)The following is an example using the registered service name "Mirroring_Controller_inst1".</pre><pre class="border">&gt; sc config "Mirroring_Controller_inst1" start= auto</pre><div class="tips"><p class="title">Information</p><div class="tipsbody"><p>You can use the sc qc command to check the registration status.<br>Refer to documentation such as Windows Help and Support for the sc command for information on registry content.</p></div></div></li><li><p>Start (rebuild) Mirroring Controller on the standby server.</p><p>This operation is required when determining the maintenance tasks on the standby server.</p><dl><dt class="em">Enabling automatic switch/disconnection</dt><dd><p>As the instance administrator user, execute the mc_ctl command in start mode.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl start -M D:\mcdir\inst1</pre></dd></dl><dl><dt class="em">Disabling automatic switch/disconnection</dt><dd><p>As the instance administrator user, execute the mc_ctl command in start mode with the -F option specified.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl start -M D:\mcdir\inst1 -F</pre></dd></dl><div class="point"><p class="title">Point</p><div class="pointbody"><p>After Mirroring Controller is started, automatic switch/disconnection can be enabled or disabled using the enable-failover or disable-failover mode of the mc_ctl command.</p></div></div></li></ol></div><p class="subhead_1" id="IDclust07N13"><span class="em">Switching to the primary server</span></p><div class="textblock"><p>To perform the maintenance on the primary server, execute the mc_ctl command in the switch mode on the primary server or the standby server.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl switch -M D:\mcdir\inst1</pre><p>When the switch is complete, the synchronous_standby_names parameter in the postgresql.conf file of the new primary server will be commented as follows:</p><pre>Example)</pre><pre class="border">#synchronous_standby_names = 'primary'</pre></div><p class="subhead_1" id="IDclust07N14"><span class="em">New standby server maintenance tasks</span></p><div class="textblock"><ol><li><p>Stop the Mirroring Controller.</p><p>On the new standby server (the primary server before the switch), execute the mc_ctl command in stop mode. </p><pre>Example)</pre><pre class="border">&gt; mc_ctl stop -M D:\mcdir\inst1</pre></li><li><p>Ensure that Mirroring Controller has completely stopped.</p><p>If the multiplexed instances and Mirroring Controller have been configured on the new standby server to start and stop automatically when the operating system of the database server is started or stopped, cancel the setting to start and stop automatically now.</p><div class="ref"><p class="title">See</p><div class="refbody"><p>Refer to "<a href="b1440-00-02-12-00.html">2.12 Setting Automatic Start and Stop of Mirroring Controller and Multiplexed Instances</a>" for information on how to configure the multiplexed instances and Mirroring Controller to start and stop automatically when the operating system of the database server starts and stops.</p></div></div><p>This task should be performed by an instance administrator user with administrator privileges.</p><p>Use the sc config command to disable automatic start of multiplexed instances and Mirroring Controller from the Windows service.</p><pre>Example)The following is an example using the registered service name "Mirroring_Controller_inst1".</pre><pre class="border">&gt; sc config "Mirroring_Controller_inst1" start= demand</pre><div class="tips"><p class="title">Information</p><div class="tipsbody"><p>You can use the sc qc command to check the registration status.<br>Refer to documentation such as Windows Help and Support for the sc command information on registry content.</p></div></div></li><li><p>Perform the maintenance on the new standby server that was stopped.</p></li><li><p>Create a copy of the new primary server instance on the new standby server.</p><p>Execute the pg_basebackup command to create data in the new standby server by synchronizing with the new primary server.</p><pre>Example)</pre><pre class="border">&gt; pg_basebackup -D D:\database\inst1 -X fetch --waldir=\transaction\inst1 --progress --verbose -R --dbname="application_name=<span class="i">standbyServerName</span>" -h <span class="i">primaryServerHostName</span> -p <span class="i">primaryServerPortNumber</span></pre><div class="ref"><p class="title">See</p><div class="refbody"><p>The procedure for copying the primary server instance to the standby server is the same as the procedure for setting up the standby server.</p><p>Refer to "<a href="b1440-00-02-05-02.html">2.5.2 Creating, Setting, and Registering the Standby Server Instance</a>", and then perform the recovery.</p></div></div></li><li><p>Check the settings for automatic start and stop of the multiplexed instances and Mirroring Controller.</p><p>If the multiplexed instances and Mirroring Controller were configured in step 2 to not start and stop automatically when the operating system of the database server starts and stops, then change the settings back. This step can be skipped if automatic start and stop are not required.</p><p>This task should be performed by an instance administrator user with administrator privileges.</p><p>Use the sc config command to enable automatic start of multiplexed instances and Mirroring Controller from the Windows service.</p><pre>Example)The following is an example using the registered service name "Mirroring_Controller_inst1".</pre><pre class="border">&gt; sc config "Mirroring_Controller_inst1" start= auto</pre><div class="tips"><p class="title">Information</p><div class="tipsbody"><p>You can use the sc qc command to check the registration status.<br>Refer to the document such as Windows Help and Support for the sc command for information on registry content.</p></div></div></li><li><p>After the maintenance is complete, edit the following parameters in the postgresql.conf file of the standby server as required.</p><p>Copying an instance results in the value of the synchronous_standby_names parameter becoming the specified value on the primary server. Therefore, correct it to the specified value on the standby server. If the parameter was commented out, then you must uncomment it.</p></li><li><p>On the standby server, start (rebuild) Mirroring Controller.</p><dl><dt class="em">Enabling automatic switch/disconnection</dt><dd><p>As the instance administrator user, execute the mc_ctl command in start mode.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl start -M D:\mcdir\inst1</pre></dd></dl><dl><dt class="em">Disabling automatic switch/disconnection</dt><dd><p>As the instance administrator user, execute the mc_ctl command in start mode with the -F option specified.</p><pre>Example)</pre><pre class="border">&gt; mc_ctl start -M D:\mcdir\inst1 -F</pre></dd></dl><div class="point"><p class="title">Point</p><div class="pointbody"><p>After Mirroring Controller is started, automatic switch/disconnection can be enabled or disabled using the enable-failover or disable-failover mode of the mc_ctl command.</p></div></div></li></ol></div><p class="subhead_1" id="IDclust07N15"><span class="em">Failback of the Primary Server</span></p><div class="textblock"><p>Revert the primary server and standby server to the original server configuration. Do this to execute the main job on the previous primary server. Refer to "<a href="b1440-00-04-01-01.html#mID_08010103">4.1.1.3 Failback of the Primary Server</a>" for details.</p><div class="note"><p class="title">Note</p><div class="notebody"><p>Obtain a backup as soon as this task is complete.</p></div></div></div></div><div class="header_footer"><div class="back_next"><a href="b1440-00-03-08-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1440-00-03-08-02.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2016-2021 FUJITSU LIMITED</div></div></body></html>