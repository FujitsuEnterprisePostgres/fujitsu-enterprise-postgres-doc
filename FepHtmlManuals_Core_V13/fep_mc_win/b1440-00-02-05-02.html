<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>2.5.2 Creating, Setting, and Registering the Standby Server Instance</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Cluster Operation Guide(Database Multiplexing)</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="b1440-00-02-00-00.html">Chapter&nbsp;2 Setting Up Database Multiplexing Mode</a> &gt; <a href="b1440-00-02-05-00.html">2.5 Setting Up the Standby Server</a> &gt; 2.5.2 Creating, Setting, and Registering the Standby Server Instance</div><div class="back_next"><a href="b1440-00-02-05-01.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1440-00-02-05-03.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h3 id="mID_060402">2.5.2 Creating, Setting, and Registering the Standby Server Instance<a name="N43G"></a></h3><div class="body"><div class="textblock"><p>This section explains how to create, set, and register the standby server instance.</p><div class="note"><p class="title">Note</p><div class="notebody"><p>Mirroring Controller supports instances that are registered in the Windows service.</p></div></div><div class="ref"><p class="title">See</p><div class="refbody"><ul><li><p>Refer to "<a href="b1440-a-00-00.html">Appendix&nbsp;A Parameters</a>" for details on each parameter.</p></li><li><p>Refer to "mc_ctl" in Reference for information on the command.</p></li></ul></div></div><p>Perform the following procedure:</p><ol><li><p>Prepare for setup.</p><p>Refer to "Preparations for Setup" in the Installation and Setup Guide for Server for information on the preparatory tasks to be performed before creating an instance on the standby server.</p><div class="note"><p class="title">Note</p><div class="notebody"><p>If the primary server and standby server are to be built within the same server, perform preparation to ensure that the event source names of FUJITSU Enterprise Postgres are not duplicated with that of the primary server.</p></div></div></li><li><p>When using transparent data encryption, configure the encryption settings for the storage data.</p><p>Deploy a copy of the keystore file of the primary server on the standby server.</p><p>Refer to "Database Multiplexing Mode" in the Operation Guide for details.</p></li><li><p>Execute the pg_basebackup command to create a copy of the primary server instance on the standby server.</p><pre>Example)</pre><pre class="border">&gt; pg_basebackup -D D:\database\inst1 -X fetch --waldir=E:\transaction\inst1 --progress --verbose -R --dbname="application_name=<span class="i">standbyServerName</span>" -h <span class="i">primaryServerIpAddress</span> -p <span class="i">primaryServerPortNumber</span></pre><div class="note"><p class="title">Note</p><div class="notebody"><ul><li><p>Use the pg_basebackup command with the -R option to create a standby.signal file. If you do not create the standby.signal file, the Mirroring Controller cannot be started as a standby server.</p></li><li><p>If using a method that requires password authentication for connections to the primary server, you will need to ensure that authentication is performed automatically. If the -R option is specified for the pg_basebackup command and the password parameter is specified for the --dbname option, the pg_basebackup command will set the password in the primary_conninfo parameter in postgresql.auto.conf file, enabling connections to be performed automatically.</p><p>If a password is not set in the primary_conninfo parameter in postgresql.auto.conf file, it will be necessary to create a password file (%APPDATA%postgresql\pgpass.conf), and then specify a password for the replication database.</p></li><li><p>The primary_conninfo parameter should not be set in the postgresql.conf file, but only in the postgresql.auto.conf file using the pg_basebackup command.</p></li><li><p>When executing the pg_basebackup command, consider the following for collection of transaction logs.</p><ul><li><p>When "fetch" is specified for the -X option of the command</p><p>Transaction logs are collected at the end of the backup, so it is necessary to ensure that transaction logs that occur during backup are not deleted from the primary server. Therefore, allow for a sufficient value for the wal_keep_size parameter in postgresql.conf.</p></li><li><p>When the -X option is omitted or "stream" is specified for the -X option of the command</p><p>Transaction logs are streamed, so when Mirroring Controller is running on the primary server, the connection is changed to a synchronous standby server on detection of a streaming replication connection using this command. Therefore, if a job has started on the primary server, the primary server will be impacted, therefore execute this command after stopping only the Mirroring Controller process on the primary server.</p></li></ul></li></ul></div></div><div class="ref"><p class="title">See</p><div class="refbody"><p>Refer to "Hot Standby" in the PostgreSQL Documentation for information on the standby.signal file.</p></div></div></li><li><p>Set the parameters shown in the table below in the postgresql.conf file.</p><table><caption id="mID_060402_conf_table">Table&nbsp;2.5 Parameters</caption><col><col><col><tr><th valign="top"><p>Parameter</p></th><th valign="top"><p>Content specified</p></th><th valign="top"><p>Remarks</p></th></tr><tr><td align="left" valign="top"><p>synchronous_standby_names</p></td><td align="left" valign="top"><p>'<span class="i">primaryServerName</span>'</p></td><td align="left" valign="top"><p>Required after switching the primary server and then changing the original primary server to the new standby server.</p><p>Enclose the name in single quotation marks (').</p><p>Do not change this parameter while Mirroring Controller is running.</p><p>Do not specify multiple names to this parameter as the Mirroring Controller can manage only one standby server.</p></td></tr></table></li><li><p>Register an instance to the Windows service.</p><p>Refer to "Creating an Instance" in the Installation and Setup Guide for Server for information on how to register an instance to the Windows service. Note that you should execute the pg_ctl command with the following specified for the register mode to enable Mirroring Controller to start and stop an instance:</p><ul><li><p>For the service name of the -N option, specify the name set for the db_instance_service_name parameter in the server definition file</p></li><li><p>Specify "demand" for the -S option, so that the service does not start automatically on startup of the system</p></li></ul><div class="note"><p class="title">Note</p><div class="notebody"><ul><li><p>Do not configure the Windows service of a multiplexed instance to perform automatic start, as it is started by Mirroring Controller.</p></li><li><p>If the primary server and standby server are to be built within the same server, ensure that the registered service name of the FUJITSU Enterprise Postgres instance is not duplicated with that of the primary server.</p></li></ul></div></div></li></ol><p></p></div></div><div class="header_footer"><div class="back_next"><a href="b1440-00-02-05-01.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1440-00-02-05-03.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2016-2021 FUJITSU LIMITED</div></div></body></html>