<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>15.1.2 Using Server Command</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Operation Guide</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="b1439-00-15-00-00.html">Chapter&nbsp;15 Actions when an Error Occurs</a> &gt; <a href="b1439-00-15-01-00.html">15.1 Recovering from Disk Failure (Hardware)</a> &gt; 15.1.2 Using Server Command</div><div class="back_next"><a href="b1439-00-15-01-01.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1439-00-15-02-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h3 id="br071200">15.1.2 Using Server Command</h3><div class="body"><div class="textblock"><p>Recover the database cluster by following the appropriate recovery procedure below for the disk where the failure occurred.</p><p></p></div><p class="subhead_1" id="ID07000000N5"><span class="em">If failure occurred on the data storage disk</span><span class="em"> or the t</span><span class="em">ransaction log storage directory</span><a name="N94G"></a><span class="em"></span></p><div class="textblock"><p>Follow the procedure below to recover the data storage disk or the <span class="em">t</span>ransaction log storage directory.</p><ol><li><p>Stop applications</p><p>Stop applications that are using the database.</p></li><li><p>Stop the instance</p><p>Stop the instance, refer to "<a href="b1439-00-02-01-03.html">2.1.2 Using Commands</a>" for details.</p><p>If the instance fails to stop, refer to "<a href="b1439-00-15-11-00.html">15.11 Actions in Response to Failure to Stop an Instance</a>".</p></li><li><p>Recover the failed disk</p><p>Replace the disk, and then recover the volume configuration information.</p></li><li><p>Create a storage destination directory</p><ul><li><p>If failure occurred on the data storage disk<br>Create a data storage destination directory. If a tablespace was defined, also create a directory for it.</p></li><li><p>If failure occurred on the translation log storage disk<br>Create a transaction log storage destination directory.</p></li></ul><dl><dd></dd></dl><p>In [Properties] in Windows(R) Explorer, set appropriate permissions so that only the instance administrator can access the storage destination directory. (Refer to [Help and Support] in Windows(R) for information on [Properties].)</p><div class="ref"><p class="title">See</p><div class="refbody"><p>Refer to "Preparing Directories to Deploy Resources" under "Setup" in the Installation and Setup Guide for Server for information on how to create a storage directory.</p></div></div></li><li><p>Recover the keystore, and enable automatic opening of the keystore</p><p>When the data in the database has been encrypted, restore the keystore to its state at the time of the database backup. Configure automatic opening of the keystore as necessary.</p></li><li><p>Recover the database cluster</p><p>Recover the database cluster using the backup data.</p><p>Specify the following in the pgx_rcvall command:</p><ul><li><p>Specify the data storage location in the -D option. If the -D option is omitted, the value of the PGDATA environment variable is used by default.</p></li><li><p>Specify the backup data storage location in the -B option.</p></li></ul><dl><dt class="em">Example</dt><dd></dd></dl><pre class="border">&gt; pgx_rcvall -D D:\database\inst1 -B E:\backup\inst1</pre><div class="note"><p class="title">Note</p><div class="notebody"><p>If recovery fails, remove the cause of the error in accordance with the displayed error message and then re-execute the pgx_rcvall command.</p><p>If the message "pgx_rcvall: an error occurred during recovery" is displayed, then the log recorded when recovery was executed is output after this message. The cause of the error is output in around the last fifteen lines of the log, so remove the cause of the error in accordance with the message and then re-execute the pgx_rcvall command.</p><p>The following message displayed during recovery is output as part of normal operation of pgx_rcvall command (therefore the user does not need not be concerned).</p><pre class="border">FATAL: the database system is starting up</pre></div></div></li><li><p>Start the instance</p><p>Refer to "<a href="b1439-00-02-01-03.html">2.1.2 Using Commands</a>" for information on how to start an instance.</p></li><li><p>Resume applications</p><p>Resume applications that are using the database.</p></li></ol></div><p class="subhead_1" id="ID07000000N6"><span class="em">If failure occurred on the backup </span><span class="em">data </span><span class="em">storage disk</span><a name="N95G"></a><span class="em"></span></p><div class="textblock"><p>The procedure for recovering the backup data storage disk is described below.</p><p>There are two methods of taking action:</p><ul><li><p>Performing recovery while the instance is active</p></li><li><p>Stopping the instance before performing recovery</p><br></li></ul><p>The following table shows the different steps to be performed depending on whether you stop the instance.</p><table><col><col><col><col><tr><th bgcolor="#C0C0C0" rowspan="2" valign="top"><p>No</p></th><th bgcolor="#C0C0C0" rowspan="2" valign="top"><p>Step</p></th><th bgcolor="#C0C0C0" colspan="2" valign="top"><p>Instance stopped</p></th></tr><tr><th bgcolor="#C0C0C0" valign="top"><p>No</p></th><th bgcolor="#C0C0C0" valign="top"><p>Yes</p></th></tr><tr><td align="left" valign="top"><p>1</p></td><td align="left" valign="top"><p>Confirm that transaction log mirroring has stopped</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>N</p></td></tr><tr><td align="left" valign="top"><p>2</p></td><td align="left" valign="top"><p>Stop output of archive logs</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>N</p></td></tr><tr><td align="left" valign="top"><p>3</p></td><td align="left" valign="top"><p>Stop applications</p></td><td align="center" valign="top"><p>N</p></td><td align="center" valign="top"><p>Y</p></td></tr><tr><td align="left" valign="top"><p>4</p></td><td align="left" valign="top"><p>Stop the instance</p></td><td align="center" valign="top"><p>N</p></td><td align="center" valign="top"><p>Y</p></td></tr><tr><td align="left" valign="top"><p>5</p></td><td align="left" valign="top"><p>Recover the failed disk</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>Y</p></td></tr><tr><td align="left" valign="top"><p>6</p></td><td align="left" valign="top"><p>Create a backup data storage destination directory</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>Y</p></td></tr><tr><td align="left" valign="top"><p>7</p></td><td align="left" valign="top"><p>Resume output of archive logs</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>N</p></td></tr><tr><td align="left" valign="top"><p>8</p></td><td align="left" valign="top"><p>Resume transaction log mirroring</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>N</p></td></tr><tr><td align="left" valign="top"><p>9</p></td><td align="left" valign="top"><p>Start the instance</p></td><td align="center" valign="top"><p>N</p></td><td align="center" valign="top"><p>Y</p></td></tr><tr><td align="left" valign="top"><p>10</p></td><td align="left" valign="top"><p>Run backup</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>Y</p></td></tr><tr><td align="left" valign="top"><p>11</p></td><td align="left" valign="top"><p>Resume applications</p></td><td align="center" valign="top"><p>N</p></td><td align="center" valign="top"><p>Y</p></td></tr></table><p class="supple">Y: Required<br>N: Not required</p><p>The procedure is as follows:</p><dl><dt class="em">If an instance has not been stopped</dt><dd><ol><li><p>Confirm that transaction log mirroring has stopped </p><p>Use the following SQL function to confirm that transaction log mirroring has stopped.</p><pre class="border"> postgres=# SELECT pgx_is_wal_multiplexing_paused(); pgx_is_wal_multiplexing_paused------------------- t(1 row)</pre><p>If transaction log mirroring has not stopped, then stop it using the following SQL function.</p><pre class="border">postgres=# SELECT pgx_pause_wal_multiplexing();LOG:  multiplexing of transaction log files has been stoppedpgx_pause_wal_multiplexing----------------------------(1 row)</pre></li><li><p>Stop output of archive logs</p><p>Transaction logs may accumulate during replacement of backup storage disk, and if the data storage disk or the transaction log storage disk becomes full, there is a risk that operations may not be able to continue.</p><p>To prevent this, use the following methods to stop output of archive logs.</p><ul><li><p>Changing archive_command</p><p>Specify a command that will surely complete normally, so that archive logs will be regarded as having been output.</p><p>If you specify echo, a message is output to the server log, so it may be used as a reference when you conduct investigations.</p></li><li><p>Reload the configuration file</p><p>Execute the pg_ctl reload command or the pg_reload_conf SQL function to reload the configuration file.</p></li></ul><p>If you simply want to stop output of errors without the risk that operations will not be able to continue, specify an empty string (") in archive_command and reload the configuration file.</p></li><li><p>Recover the failed disk</p><p>Replace the disk, and then recover the volume configuration information.</p></li><li><p>Create a backup data storage destination</p><dl><dd></dd></dl><p>Create a backup data storage destination.</p><p>In [Properties] in Windows(R) Explorer, set appropriate permissions so that only the instance administrator can access the backup data storage destination directory. (Refer to [Help and Support] in Windows(R) for information on [Properties].)</p><p>Refer to "<a href="b1439-00-03-02-02.html">3.2.2 Using Server Commands</a>" for information on how to create a backup data storage destination.</p></li><li><p>Resume output of archive logs</p><p>Return the archive_command setting to its original value, and reload the configuration file.</p></li><li><p>Resume transaction log mirroring</p><p>Execute the pgx_resume_wal_multiplexing SQL function.</p><dl><dt class="em">Example</dt><dd><pre class="border">SELECT pgx_resume_wal_multiplexing()</pre></dd></dl></li><li><p>Run backup</p><p>Use the pgx_dmpall command to back up the database cluster.</p><p>Specify the following value in the pgx_dmpall command:</p><ul><li><p>Specify the data storage destination in the -D option. If the -D option is omitted, the value of the PGDATA environment variable is used by default.</p></li></ul><dl><dt class="em">Example</dt><dd></dd></dl><pre class="border">&gt; pgx_dmpall -D D:\database\inst1</pre><br></li></ol></dd></dl><dl><dt class="em">If an instance has been stopped</dt><dd><ol><li><p>Stop applications</p><p>Stop applications that are using the database.</p></li><li><p>Stop the instance</p><p>Stop the instance. Refer to "<a href="b1439-00-02-01-03.html">2.1.2 Using Commands</a>" for details.</p><p>If the instance fails to stop, refer to "<a href="b1439-00-15-11-00.html">15.11 Actions in Response to Failure to Stop an Instance</a>".</p></li><li><p>Recover the failed disk</p><p>Replace the disk, and then recover the volume configuration information.</p></li><li><p>Create a backup data storage destination</p><dl><dd></dd></dl><p>Create a backup data storage destination.</p><p>In [Properties] in Windows(R) Explorer, set appropriate permissions so that only the instance administrator can access the backup data storage destination directory. (Refer to [Help and Support] in Windows(R) for information on [Properties].)</p><p>Refer to "<a href="b1439-00-03-02-02.html">3.2.2 Using Server Commands</a>" for details.</p></li><li><p>Start the instance</p><p>Start the instance. Refer to "<a href="b1439-00-02-01-03.html">2.1.2 Using Commands</a>" for information on how to start an instance.</p></li><li><p>Run backup</p><p>Use the pgx_dmpall command to back up the database cluster.</p><p>Specify the following value in the pgx_dmpall command:</p><ul><li><p>Specify the data storage destination in the -D option. If the -D option is omitted, the value of the PGDATA environment variable is used by default.</p></li></ul><dl><dt class="em">Example</dt><dd></dd></dl><pre class="border">&gt; pgx_dmpall -D D:\database\inst1</pre></li><li><p>Resume applications</p><p>Resume applications that are using the database.</p></li></ol></dd></dl><div class="ref"><p class="title">See</p><div class="refbody"><ul><li><p>Refer to "pgx_rcvall" and "pgx_dmpall" in the Reference for information on the pgx_rcvall command and pgx_dmpall command.</p></li><li><p>Refer to "Write Ahead Log" under "Server Administration" in the PostgreSQL Documentation for information on archive_command.</p></li><li><p>Refer to "<a href="b1439-b-01-00.html">B.1 WAL Mirroring Control Functions</a>" for information on pgx_resume_wal_multiplexing.</p></li></ul></div></div></div></div><div class="header_footer"><div class="back_next"><a href="b1439-00-15-01-01.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1439-00-15-02-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2015-2021 FUJITSU LIMITED</div></div></body></html>