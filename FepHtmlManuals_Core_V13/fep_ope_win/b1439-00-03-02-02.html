<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>3.2.2 Using Server Commands</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Operation Guide</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="b1439-00-03-00-00.html">Chapter&nbsp;3 Backing Up the Database</a> &gt; <a href="b1439-00-03-02-00.html">3.2 Backup Methods</a> &gt; 3.2.2 Using Server Commands</div><div class="back_next"><a href="b1439-00-03-02-01.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1439-00-04-00-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h3 id="br032200">3.2.2 Using Server Commands</h3><div class="body"><div class="textblock"><p>Use the pgx_dmpall command and pgx_rcvall command to perform backup and check the backup result.</p><p></p></div><p class="subhead_1" id="ID03000000N4"><span class="em">Preparing for backup</span></p><div class="textblock"><p>You must prepare for backup before actually starting the backup process.</p><p>Follow the procedure below.</p><div class="ref"><p class="title">See</p><div class="refbody"><p>Refer to "Preparing Directories to Deploy Resources" in the Installation and Setup Guide for Server for information on the location of directories required for backup and for points to take into account.</p></div></div><ol><li><p>Prepare the backup data storage disk</p><p>For backup, prepare a separate disk unit from the database storage disk and mount it using the operating system commands.</p></li><li><p>Create a directory where the backup data will be stored</p><p>Create an empty directory. </p><dl><dd></dd></dl><p>In [Properties] in Windows(R) Explorer, set appropriate permissions so that only the instance administrator can access the directory.</p><div class="ref"><p class="title">See</p><div class="refbody"><p>Refer to [Help and Support] in Windows(R) for information on [Properties].</p></div></div></li><li><p>Specify the settings required for backup</p><p>Stop the instance, and set the following parameters in the postgresql.conf file.</p><p>Start the instance after editing the postgresql.conf file.</p><table><col><col><col><tr><th valign="top"><p><span class="em">Parameter name</span></p></th><th valign="top"><p><span class="em">Setting</span></p></th><th valign="top"><p><span class="em">Description</span></p></th></tr><tr><td align="left" valign="top"><p>backup_destination</p></td><td align="left" valign="top"><p>Name of the directory where the backup data will be stored</p></td><td align="left" valign="top"><p>Specify the name of the directory where the backup data will be stored.</p><p>Appropriate privileges that allow only the instance administrator to access the directory must already be set.</p><p>Place the backup data storage destination directory outside the data storage destination directory, the tablespace directory, and the transaction log storage destination directory.</p></td></tr><tr><td align="left" valign="top"><p>archive_mode</p></td><td align="left" valign="top"><p>on</p></td><td align="left" valign="top"><p>Specify the archive log mode.</p><p>Specify [on] (execute).</p></td></tr><tr><td align="left" valign="top"><p>archive_command</p></td><td align="left" valign="top"><p>'cmd /c ""<span class="i">installationDirectory</span>\\bin\\pgx_walcopy.cmd" "%p" "<span class="i">backupDataStorageDestinationDirectory</span>\\archived_wal\\%f""'</p></td><td align="left" valign="top"><p>Specify the path name of the command that will save the transaction log and the storage destination.</p><p>Note the following when specifying the path:</p><ul><li><p>Specify \\ as the path delimiter.</p></li><li><p>Enclose the path in double quotes ("") if it contains spaces.</p></li></ul></td></tr></table><p>Refer to "<a href="b1439-a-00-00.html">Appendix&nbsp;A Parameters</a>" and "Write Ahead Log" under "Server Administration" in the PostgreSQL Documentation for information on the parameters.</p></li></ol></div><p class="subhead_1" id="ID03000000N5"><span class="em">Backup operation</span><span class="em"> (file backup)</span><a name="N23G"></a></p><div class="textblock"><p>Use the pgx_dmpall command to perform file backup. You can even embed the pgx_dmpall command in OS automation software to perform backup.</p><p>The backup data is stored in the directory specified in the backup_destination parameter of postgresql.conf.</p><p>Specify the data storage destination in the -D option. If the -D option is omitted, the value of the PGDATA environment variable is used by default.</p><div class="ex"><p class="title">Example</p><div class="exbody"><pre class="border">&gt; pgx_dmpall -D D:\database\inst1</pre></div></div><div class="note"><p class="title">Note</p><div class="notebody"><p>Backup stores the data obtained during the backup and the backup data of the data obtained during previous backup.</p><p>If the data to be stored in the database is encrypted, refer to the following and back up the keystore:</p><ul><li><p><a href="b1439-00-05-06-04.html">5.6.4 Backing Up and Recovering the Keystore</a></p></li></ul></div></div></div><p class="subhead_1" id="ID03000000N6"><span class="em">Backup status</span><a name="N24G"></a></p><div class="textblock"><p>Use the pgx_rcvall command to check the backup status.</p><p>Specify the following values in the pgx_rcvall command:</p><ul><li><p>The -l option indicates backup data information.</p></li><li><p>Specify the data storage destination in the -D option. If the -D option is omitted, the value of the PGDATA environment variable is used by default.</p></li></ul><pre class="border">&gt; pgx_rcvall -l -D D:\database\inst1Date                    Status          Dir2020-05-01 13:30:40     COMPLETE        E:/backup/inst1/2020-05-01_13-30-40</pre><p>If an error occurs and backup fails, a message is output to the event log.</p><p>In this case, the backup data is not optimized. Ensure that you check the backup result whenever you perform backup. If backup fails, remove the cause of failure and perform backup again.</p><div class="ref"><p class="title">See</p><div class="refbody"><p>Refer to "pgx_dmpall" and "pgx_rcvall" in the Reference for information on the pgx_dmpall command and pgx_rcvall command.</p></div></div></div><p class="subhead_1" id="ID03000000N7"><span class="em">Setting a restore point</span><a name="N25G"></a><span class="em"></span></p><div class="textblock"><p>In case you want to recover your database to a certain point in time, you can name this particular point in time, which is referred to as the restore point, by using the psql command.</p><p>By setting a restore point before executing an application, it becomes easy to identify up to which point in time the data will be reverted.</p><p>A restore point can be set to any point in time after a backup is executed. However, if a restore point is set before a backup is executed, the database cannot be recovered to that point in time. This is because restore points are recorded in the archive logs, and the archive logs are discarded when backups are executed.</p><div class="ex"><p class="title">Example</p><div class="exbody"><p>The following example uses the psql command to connect to the database and execute the SQL statement to set a restore point.</p><p>However, when considering continued compatibility of applications, do not use functions directly in SQL statements. Refer to "Notes on Application Compatibility" in the Application Development Guide for details.</p><pre class="border">postgres=# SELECT pg_create_restore_point('batch_20200503_1');LOG:  restore point "batch_20200503_1" created at 0/20000E8STATEMENT:  select pg_create_restore_point('batch_20200503_1'); pg_create_restore_point------------------------- 0/20000E8(1 row)</pre></div></div><p>Refer to "<a href="b1439-00-15-03-02.html">15.3.2 Using the pgx_rcvall Command</a>" for information on using a restore point to recover the database.</p><div class="note"><p class="title">Note</p><div class="notebody"><ul><li><p>Name restore points so that they are unique within the database. Add the date and time of setting a restore point to distinguish it from other restore points, as shown below:</p><ul><li><p>YYMMDD_HHMMSS</p><ul><li><p>YYMMDD: Indicates the date</p></li><li><p>HHMMSS: Indicates the time</p></li></ul></li></ul></li><li><p>There is no way to check restore points you have set. Keep a record in, for example, a file.</p></li></ul></div></div><div class="ref"><p class="title">See</p><div class="refbody"><p>Refer to "System Administration Functions" under "Functions and Operators" in the PostgreSQL Documentation for information on pg_create_restore_point.</p></div></div></div></div><div class="header_footer"><div class="back_next"><a href="b1439-00-03-02-01.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1439-00-04-00-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2015-2021 FUJITSU LIMITED</div></div></body></html>