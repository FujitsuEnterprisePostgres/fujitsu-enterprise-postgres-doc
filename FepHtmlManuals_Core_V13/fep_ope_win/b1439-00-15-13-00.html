<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>15.13 Actions in Response to Error in a Distributed Transaction</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Operation Guide</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="b1439-00-15-00-00.html">Chapter&nbsp;15 Actions when an Error Occurs</a> &gt; 15.13 Actions in Response to Error in a Distributed Transaction</div><div class="back_next"><a href="b1439-00-15-12-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1439-00-15-14-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h2 id="br0712000">15.13 Actions in Response to Error in a Distributed Transaction</h2><div class="body"><div class="textblock"><p>If a system failure (such as server failure) occurs in an application that uses distributed transactions (such as .NET TransactionScope), then transactions may be changed to the in-doubt state.</p><p>At that point, resources accessed by the transaction will be locked, and rendered unusable by other transactions.</p><p>The following describes how to check for in-doubt transactions, and how to resolve them.</p><p></p></div><p class="subhead_1" id="ID07000000N12"><span class="em">How to check for in-doubt transactions</span></p><div class="textblock"><p>The following shows how to check for them:</p><dl><dt class="em">If the server fails</dt><dd><ol><li><p>An in-doubt transaction will have occurred if a message similar to the one below is output to the log when the server is restarted.</p><dl><dt class="em">Example</dt><dd><pre class="border">LOG: Restoring prepared transaction 2103.</pre></dd></dl></li><li><p>Refer to system view pg_prepared_xacts to obtain information about the prepared transaction.</p><p>If the transaction identifier of the prepared transaction in the list (in the transaction column of pg_prepared_xacts) is the same as the identifier of the in-doubt transaction obtained from the log output when the server was restarted, then that row is the information about the in-doubt transaction.</p><dl><dt class="em">Example</dt><dd><pre class="border">postgres=# select * from pg_prepared_xacts; transaction |   gid     |   prepared |  owner   | database-------------+-----------+------------+----------+----------<span class="em">2103</span> | <span class="em">374cc221-f6dc-4b73-9d62-d4fec9b430cd</span> | 2020-05-06 16:28:48.471+08 | postgres | postgres (1 row)</pre><p>Information about the in-doubt transaction is output to the row with the transaction ID 2103 in the transaction column.</p></dd></dl></li></ol></dd></dl><dl><dt class="em">If the client fails</dt><dd><p>If there are no clients connected and there is a prepared transaction in pg_prepared_xacts, then you can determine that the transaction is in the in-doubt state.</p><p>If at least one client is connected and there is a prepared transaction in pg_prepared_xacts, you cannot determine whether there is a transaction in the in-doubt state. In this case, use the following query to determine the in-doubt transaction from the acquired database name, user name, the time PREPARE TRANSACTION was executed, and the information about the table name accessed.</p><pre class="border">select gid,x.database,owner,prepared,l.relation::regclass as relation from pg_prepared_xacts x left join pg_locks l on l.virtualtransaction = '-1/'||x.transaction and l.locktype='relation';</pre><p> </p><p>If it still cannot be determined from this information, wait a few moments and then check pg_prepared_xacts again.</p><p>If there is a transaction that has continued since the last time you checked, then it is likely that it is the one in the in-doubt state.</p><div class="point"><p class="title">Point</p><div class="pointbody"><p>As you can see from the explanations in this section, there is no one way to definitively determine in-doubt transactions.</p><p>Consider collecting other supplementary information (for example, logging on the client) or performing other operations (for example, allocating database users per job).</p></div></div></dd></dl></div><p class="subhead_1" id="ID07000000N13"><span class="em">How to resolve in-doubt transactions</span></p><div class="textblock"><p>From the system view pg_prepared_xacts mentioned above, obtain the global transaction identifier (in the gid column of pg_prepared_xacts) for the in-doubt transaction, and issue either a ROLLBACK PREPARED statement or COMMIT PREPARED statement to resolve the in-doubt transaction.</p><div class="ex"><p class="title">Example</p><div class="exbody"><ul><li><p>Rolling back in-doubt transactions</p><pre class="border">postgres=# rollback prepared '<span class="em">374cc221-f6dc-4b73-9d62-d4fec9b430cd</span>';ROLLBACK PREPARED</pre></li></ul><ul><li><p>Committing in-doubt transactions</p><pre class="border">postgres=# commit prepared '<span class="em">374cc221-f6dc-4b73-9d62-d4fec9b430cd</span>';COMMIT PREPARED</pre></li></ul></div></div></div></div><div class="header_footer"><div class="back_next"><a href="b1439-00-15-12-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1439-00-15-14-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2015-2021 FUJITSU LIMITED</div></div></body></html>