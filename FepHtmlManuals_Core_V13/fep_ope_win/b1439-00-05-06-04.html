<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>5.6.4 Backing Up and Recovering the Keystore</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Operation Guide</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="b1439-00-05-00-00.html">Chapter&nbsp;5 Protecting Storage Data Using Transparent Data Encryption</a> &gt; <a href="b1439-00-05-06-00.html">5.6 Managing the Keystore</a> &gt; 5.6.4 Backing Up and Recovering the Keystore</div><div class="back_next"><a href="b1439-00-05-06-03.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1439-00-05-07-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h3 id="br056400">5.6.4 Backing Up and Recovering the Keystore<a name="N43G"></a></h3><div class="body"><div class="textblock"><p>Back up the keystore at the following times in case it is corrupted or lost. Note that you must store the database and the keystore on separate data storage media. Storing both on the same data storage medium risks the danger of the encrypted data being deciphered if the medium is stolen. A passphrase is not required to open an automatically opening keystore, so store this type of keystore in a safe location.</p><ul><li><p>When the master encryption key is first configured</p></li><li><p>When the master encryption key is changed</p></li><li><p>When the database is backed up</p></li><li><p>When the keystore passphrase is changed</p></li></ul><div class="point"><p class="title">Point</p><div class="pointbody"><p>Do not overwrite an old keystore when backing up a keystore. This is because during database recovery, you must restore the keystore to its state at the time of database backup. When the backup data of the database is no longer required, delete the corresponding keystore.</p></div></div><div class="ex"><p class="title">Example</p><div class="exbody"><ul><li><p>Back up the database and the keystore on May 1, 2020.</p><pre class="border">&gt; pgx_dmpall -D D:\database\inst1&gt; copy C:\key\store\location\keystore.ks C:\keybackup\keystore_20200501.ks</pre><p>Specify the following in the pgx_dmpall command:</p><ul><li><p>Specify the data storage destination in the -D option. If the -D option is omitted, the value of the PGDATA environment variable is used by default.</p></li></ul></li><li><p>Change the master encryption key, and back up the keystore on May 5, 2020.</p><pre class="border">&gt; psql -c "SELECT pgx_set_master_key('passphrase')" postgres&gt; copy C:\key\store\location\keystore.ks C:\keybackup\keystore_20200505.ks</pre><p>Specify the following in the psql command:</p><ul><li><p>Specify the SQL function that sets the master encryption key in the -c option.</p></li><li><p>Specify the name of the database to be connected to as the argument.</p></li></ul></li></ul></div></div><p>If the keystore is corrupted or lost, restore the keystore containing the latest master encryption key. If there is no keystore containing the latest master encryption key, restore the keystore to its state at the time of database backup, and recover the database from the database backup. This action recovers the keystore to its latest state.</p><div class="ex"><p class="title">Example</p><div class="exbody"><ul><li><p>Restore the keystore containing the latest master encryption key as of May 5, 2020.</p><pre class="border">&gt; copy C:\keybackup\keystore_20200505.ks C:\key\store\location\keystore.ks</pre></li><li><p>If there is no backup of the keystore containing the latest master encryption key, recover the keystore by restoring the keystore that was backed up along with the database on 1 May 2020.</p><pre class="border">&gt; copy C:\keybackup\keystore_20200501.ks C:\key\store\location\keystore.ks&gt; pgx_rcvall -B E:\backup\inst1 -D D:\database\inst1 --keystore-passphrase</pre><p>Specify the following in the pgx_rcvall command:</p><ul><li><p>Specify the data storage directory in the -D option. If the -D option is omitted, the value of the PGDATA environment variable is used by default.</p></li><li><p>Specify the backup data storage directory in the -B option.</p></li><li><p>The --keystore-passphrase option prompts you to enter the passphrase to open the keystore.</p></li></ul></li></ul></div></div><p>If you have restored the keystore, repeat the process of enabling automatic opening of the keystore. This ensures that the contents of the automatically opening keystore (keystore.aks) are identical to the contents of the restored keystore.</p><p>It is recommended that you do not back up the automatically opening keystore file, keystore.aks. If the database backup medium and the backup medium storing the automatically opening keystore are both stolen, the attacker will be able to read the data even without knowing the passphrase.</p><p>If the automatically opening keystore is corrupted or lost, you must again enable automatic opening. The keystore.aks file will be recreated from keystore.ks at this time.</p><div class="ref"><p class="title">See</p><div class="refbody"><p>Refer to "pgx_rcvall" and "pgx_dmpall" in the Reference for information on the pgx_rcvall and pgx_dmpall commands.</p><p>Refer to "psql" under "Reference" in the PostgreSQL Documentation for information on the psql command.</p><p>Refer to "<a href="b1439-b-02-00.html">B.2 Transparent Data Encryption Control Functions</a>" for information on the pgx_set_master_key function.</p><p>Refer to "<a href="b1439-00-05-06-03.html">5.6.3 Enabling Automatic Opening of the Keystore</a>" for information on how to enable automatic opening of the keystore. </p></div></div><p></p></div></div><div class="header_footer"><div class="back_next"><a href="b1439-00-05-06-03.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="b1439-00-05-07-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2015-2021 FUJITSU LIMITED</div></div></body></html>