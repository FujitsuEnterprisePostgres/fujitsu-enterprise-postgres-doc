<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>15.7.2 Replacing the Disk with a Larger Capacity Disk</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Operation Guide</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="j2677-00-15-00-00.html">Chapter&nbsp;15 Actions when an Error Occurs</a> &gt; <a href="j2677-00-15-07-00.html">15.7 Actions in Response to Insufficient Space on the Backup Data Storage Destination</a> &gt; 15.7.2 Replacing the Disk with a Larger Capacity Disk</div><div class="back_next"><a href="j2677-00-15-07-01.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2677-00-15-08-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h3 id="br077200">15.7.2 Replacing the Disk with a Larger Capacity Disk</h3><div class="body"><div class="textblock"><p>This method involves replacing the disk at the backup data storage destination with a larger capacity disk, so that it does not run out of free space again. After replacing the disk, back up data to obtain a proper backup.</p><p>There are two methods of performing backup:</p><ul><li><p><a href="j2677-00-15-07-02.html#br077210">15.7.2.1 Using WebAdmin</a></p></li><li><p><a href="j2677-00-15-07-02.html#br077220">15.7.2.2 Using Server Commands</a></p></li></ul><p> </p><div class="note"><p class="title">Note</p><div class="notebody"><p>Before replacing the disk, stop applications that are using the database.</p></div></div><p></p></div></div><h4 id="br077210">15.7.2.1 Using WebAdmin</h4><div class="body"><div class="textblock"><p>Follow the procedure below to recover the backup storage disk.</p><ol><li><p>Back up files</p><p>If the disk at the backup data storage destination contains any required files, back up the files. It is not necessary to back up the backup data storage destination.</p></li><li><p>Temporarily save backup data</p><p>Save the backup data to a different directory.</p><p>The reason for saving the backup data is so that the data in the data storage destination can be recovered even if it is corrupted before you perform the next step. If there is no disk at the save destination and you consider that there is no risk of corruption at the data storage destination, delete the backup data.</p><p>The following example saves backup data from the backup data storage destination directory (/backup/inst1) under /mnt/usb/backup.</p><dl><dt class="em">Example</dt><dd><pre class="border">&gt; mkdir /mnt/usb/backup/&gt; mv /backup/inst1/* /mnt/usb/backup/</pre></dd></dl><dl><dd></dd></dl></li><li><p>Replace with a larger capacity disk</p><p>Replace the disk. Then, recover the volume configuration information.</p></li><li><p>Run backup</p><p>Log in to WebAdmin, and perform recovery operations. Refer to steps 2 ("Recover the backup data") and 3 ("Run backup") under "If failure occurred on the backup storage disk" in "<a href="j2677-00-15-01-01.html">15.1.1 Using WebAdmin</a>".</p></li><li><p>Restore files</p><p>Restore the files backed up in step 1.</p></li><li><p>Delete temporarily saved backup data</p><p>If backup completes normally, the temporarily saved backup data becomes unnecessary and is deleted.</p><p>The following example deletes backup data that was temporarily saved in /mnt/usb.</p><dl><dt class="em">Example</dt><dd><pre class="border">&gt; rm -rf /mnt/usb/backup</pre></dd></dl><dl><dd></dd></dl></li></ol></div></div><h4 id="br077220">15.7.2.2 Using Server Commands</h4><div class="body"><div class="textblock"><p>The procedure for recovering the backup data storage disk is described below.</p><p>There are two methods of taking action:</p><ul><li><p>Performing recovery while the instance is active</p></li><li><p>Stopping the instance before performing recovery</p></li></ul><p>The following table shows the different steps to be performed depending on whether you stop the instance.</p><table><col><col><col><col><tr><th bgcolor="#C0C0C0" rowspan="2" valign="top"><p>No</p></th><th bgcolor="#C0C0C0" rowspan="2" valign="top"><p>Step</p></th><th bgcolor="#C0C0C0" colspan="2" valign="top"><p>Instance stopped</p></th></tr><tr><th bgcolor="#C0C0C0" valign="top"><p>No</p></th><th bgcolor="#C0C0C0" valign="top"><p>Yes</p></th></tr><tr><td align="left" valign="top"><p>1</p></td><td align="left" valign="top"><p>Back up files</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>Y</p></td></tr><tr><td align="left" valign="top"><p>2</p></td><td align="left" valign="top"><p>Temporarily save backup data</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>Y</p></td></tr><tr><td align="left" valign="top"><p>3</p></td><td align="left" valign="top"><p>Confirm that transaction log mirroring has stopped</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>N</p></td></tr><tr><td align="left" valign="top"><p>4</p></td><td align="left" valign="top"><p>Stop output of archive logs</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>N</p></td></tr><tr><td align="left" valign="top"><p>5</p></td><td align="left" valign="top"><p>Stop applications</p></td><td align="center" valign="top"><p>N</p></td><td align="center" valign="top"><p>Y</p></td></tr><tr><td align="left" valign="top"><p>6</p></td><td align="left" valign="top"><p>Stop the instance</p></td><td align="center" valign="top"><p>N</p></td><td align="center" valign="top"><p>Y</p></td></tr><tr><td align="left" valign="top"><p>7</p></td><td align="left" valign="top"><p>Replace with a larger capacity disk</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>Y</p></td></tr><tr><td align="left" valign="top"><p>8</p></td><td align="left" valign="top"><p>Create a backup storage directory</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>Y</p></td></tr><tr><td align="left" valign="top"><p>9</p></td><td align="left" valign="top"><p>Resume output of archive logs</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>N</p></td></tr><tr><td align="left" valign="top"><p>10</p></td><td align="left" valign="top"><p>Resume transaction log mirroring</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>N</p></td></tr><tr><td align="left" valign="top"><p>11</p></td><td align="left" valign="top"><p>Start the instance</p></td><td align="center" valign="top"><p>N</p></td><td align="center" valign="top"><p>Y</p></td></tr><tr><td align="left" valign="top"><p>12</p></td><td align="left" valign="top"><p>Run backup</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>Y</p></td></tr><tr><td align="left" valign="top"><p>13</p></td><td align="left" valign="top"><p>Resume applications</p></td><td align="center" valign="top"><p>N</p></td><td align="center" valign="top"><p>Y</p></td></tr><tr><td align="left" valign="top"><p>14</p></td><td align="left" valign="top"><p>Restore files</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>Y</p></td></tr><tr><td align="left" valign="top"><p>15</p></td><td align="left" valign="top"><p>Delete temporarily saved backup data</p></td><td align="center" valign="top"><p>Y</p></td><td align="center" valign="top"><p>Y</p></td></tr></table><p class="supple">Y: Required<br>N: Not required</p><br><p>The procedure is as follows:</p><dl><dt class="em">If an instance has not been stopped</dt><dd><ol><li><p>Back up files</p><p>If the disk at the backup data storage destination contains any required files, back up the files. It is not necessary to back up the backup data storage destination.</p></li><li><p>Temporarily save backup data</p><p>Save the backup data to a different directory.</p><p>The reason for saving the backup data is so that the data in the data storage destination can be recovered even if it is corrupted before you perform the next step. If there is no disk at the save destination and you consider that there is no risk of corruption at the data storage destination, delete the backup data.</p><p>The following example saves backup data from the backup data storage destination directory (/backup/inst1) under /mnt/usb/backup.</p><dl><dt class="em">Example</dt><dd><pre class="border">&gt; mkdir /mnt/usb/backup/&gt; mv /backup/inst1/* /mnt/usb/backup/</pre></dd></dl><dl><dd></dd></dl></li><li><p>Confirm that transaction log mirroring has stopped</p><p>Use the following SQL function to confirm that transaction log mirroring has stopped.</p><pre class="border"> postgres=# SELECT pgx_is_wal_multiplexing_paused(); pgx_is_wal_multiplexing_paused------------------- t(1 row)</pre><p>If transaction log mirroring has not stopped, then stop it using the following SQL function.</p><pre class="border">postgres=# SELECT pgx_pause_wal_multiplexing();LOG:  multiplexing of transaction log files has been stoppedpgx_pause_wal_multiplexing----------------------------(1 row)</pre></li><li><p>Stop output of archive logs</p><p>Transaction logs may accumulate during replacement of backup storage disk, and if the data storage destination disk or the transaction log storage destination disk becomes full, there is a risk that operations may not be able to continue.</p><p>To prevent this, use the following methods to stop output of archive logs.</p><ul><li><p>Changing the archive_command parameter</p><p>Specify a command that will surely complete normally, such as "echo skipped archiving WAL file %f" or "/bin/true", so that archive logs will be regarded as having been output.</p><p>If you specify echo, a message is output to the server log, so it may be used as a reference when you conduct investigations.</p></li><li><p>Reloading the configuration file</p><p>Run the pg_ctl reload command or the pg_reload_conf SQL function.</p></li></ul><p>If you simply want to stop output of errors without the risk that operations will not be able to continue, specify an empty string (") in archive_command and reload the configuration file.</p></li><li><p>Replace with a larger capacity disk</p><p>Replace the disk. Then, recover the volume configuration information.</p></li><li><p>Create a backup data storage destination</p><p>Create a backup data storage destination.</p><dl><dt class="em">Example</dt><dd><pre class="border"># mkdir /backup/inst1# chown fsepuser:fsepuser /backup/inst1# chmod 700 /backup/inst1</pre></dd></dl><p>Refer to "<a href="j2677-00-03-02-02.html">3.2.2 Using Server Commands</a>" for details.</p></li><li><p>Resume output of archive logs</p><p>Return the archive_command setting to its original value, and reload the configuration file.</p></li><li><p>Resume transaction log mirroring</p><p>Execute the pgx_resume_wal_multiplexing SQL function.</p><dl><dt class="em">Example</dt><dd><pre class="border">SELECT pgx_resume_wal_multiplexing()</pre></dd></dl></li><li><p>Run backup</p><p>Use the pgx_dmpall command to back up the database cluster.</p><p>Specify the following value in the pgx_dmpall command:</p><ul><li><p>Specify the data storage destination in the -D option. If the -D option is omitted, the value of the PGDATA environment variable is used by default.</p></li></ul><dl><dt class="em">Example</dt><dd></dd></dl><pre class="border">&gt; pgx_dmpall -D /database/inst1</pre></li><li><p>Restore files</p><p>Restore the files backed up in step 1.</p></li><li><p>Delete temporarily saved backup data</p><p>If backup completes normally, the temporarily saved backup data becomes unnecessary and is deleted.</p><p>The following example deletes backup data that was temporarily saved in /mnt/usb.</p><dl><dt class="em">Example</dt><dd><pre class="border">&gt; rm -rf /mnt/usb/backup</pre></dd></dl><dl><dd></dd></dl><br></li></ol></dd></dl><dl><dt class="em">If an instance has been stopped</dt><dd><ol><li><p>Back up files</p><p>If the disk at the backup data storage destination contains any required files, back up the files. It is not necessary to back up the backup data storage destination.</p></li><li><p>Temporarily save backup data</p><p>Save the backup data to a different directory.</p><p>The reason for saving the backup data is so that the data in the data storage destination can be recovered even if it is corrupted before you perform the next step. If there is no disk at the save destination and you consider that there is no risk of corruption at the data storage destination, delete the backup data.</p><p>The following example saves backup data from the backup data storage destination directory (/backup/inst1) under /mnt/usb/backup.</p><dl><dt class="em">Example</dt><dd><pre class="border">&gt; mkdir /mnt/usb/backup/&gt; mv /backup/inst1/* /mnt/usb/backup/</pre></dd></dl><dl><dd></dd></dl></li><li><p>Stop applications</p><p>Stop applications that are using the database.</p></li><li><p>Stop the instance</p><p>Stop the instance. Refer to "<a href="j2677-00-02-01-02.html">2.1.2 Using Server Commands</a>" for information on how to stop an instance.</p><p>If the instance fails to stop, refer to "<a href="j2677-00-15-11-00.html">15.11 Actions in Response to Failure to Stop an Instance</a>".</p></li><li><p>Replace with a larger capacity disk</p><p>Replace the disk. Then, recover the volume configuration information.</p></li><li><p>Create a backup data storage destination</p><p>Create a backup data storage destination.</p><dl><dt class="em">Example</dt><dd><pre class="border"># mkdir /backup/inst1# chown fsepuser:fsepuser /backup/inst1# chmod 700 /backup/inst1</pre></dd></dl><p>Refer to "<a href="j2677-00-03-02-02.html">3.2.2 Using Server Commands</a>" for details.</p></li><li><p>Start the instance</p><p>Start the instance. Refer to "<a href="j2677-00-02-01-02.html">2.1.2 Using Server Commands</a>" for information on how to start an instance.</p></li><li><p>Run backup</p><p>Use the pgx_dmpall command to back up the database cluster.</p><p>Specify the following value in the pgx_dmpall command:</p><ul><li><p>Specify the data storage destination in the -D option. If the -D option is omitted, the value of the PGDATA environment variable is used by default.</p></li></ul><dl><dt class="em">Example</dt><dd></dd></dl><pre class="border">&gt; pgx_dmpall -D /database/inst1</pre></li><li><p>Resume applications</p><p>Resume applications that are using the database.</p></li><li><p>Restore files</p><p>Restore the files backed up in step 1.</p></li><li><p>Delete temporarily saved backup data</p><p>If backup completes normally, the temporarily saved backup data becomes unnecessary and is deleted.</p><p>The following example deletes backup data that was temporarily saved in /mnt/usb.</p><dl><dt class="em">Example</dt><dd><pre class="border">&gt; rm -rf /mnt/usb/backup</pre></dd></dl><dl><dd></dd></dl><br></li></ol></dd></dl><div class="ref"><p class="title">See</p><div class="refbody"><ul><li><p>Refer to "pgx_rcvall" and "pgx_dmpall" in the Reference for information on the pgx_rcvall command and pgx_dmpall command.</p></li><li><p>Refer to "Write Ahead Log" under "Server Administration" in the PostgreSQL Documentation for information on archive_command.</p></li><li><p>Refer to "<a href="j2677-b-01-00.html">B.1 WAL Mirroring Control Functions</a>" for information on the pgx_is_wal_multiplexing_paused and pgx_resume_wal_multiplexing.</p></li></ul></div></div></div></div><div class="header_footer"><div class="back_next"><a href="j2677-00-15-07-01.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2677-00-15-08-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2015-2021 FUJITSU LIMITED</div></div></body></html>