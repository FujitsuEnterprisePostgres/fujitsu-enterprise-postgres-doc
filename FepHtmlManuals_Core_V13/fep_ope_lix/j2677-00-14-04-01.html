<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>14.4.1 Copy Command for Backup</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Operation Guide</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="j2677-00-14-00-00.html">Chapter&nbsp;14 Backup/Recovery Using the Copy Command</a> &gt; <a href="j2677-00-14-04-00.html">14.4 Copy Command Interface</a> &gt; 14.4.1 Copy Command for Backup</div><div class="back_next"><a href="j2677-00-14-04-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2677-00-14-04-02.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h3 id="br0d_copy0401">14.4.1 Copy Command for Backup<a name="N89G"></a></h3><div class="body"><div class="textblock"><p></p></div><p class="subhead_1" id="ID0d00-copyN10"><span class="em">Feature</span></p><div class="textblock"><p>User exit (for the copy command) called from the pgx_dmpall command.</p></div><p class="subhead_1" id="ID0d00-copyN11"><span class="em">Format</span></p><div class="textblock"><p>The syntax for calling the copy command from the pgx_dmpall command is described below.</p><dl><dt class="em">If the operation mode is "prepare"</dt><dd><pre class="border"><span class="i">copyCommandName</span> prepare<span class="i"> 'pathOfBackupInfoFile' 'pathOfBackupTargetListFile'</span></pre></dd></dl><dl><dt class="em">If the operation mode is "backup"</dt><dd><pre class="border"><span class="i">copyCommandName</span><span class="i"> </span>backup</pre></dd></dl><dl><dt class="em">If the operation mode is "finalize"</dt><dd><pre class="border"><span class="i">copyCommandName</span><span class="i"> </span>finalize <span class="i">'pathOfBackupInfoFile'</span></pre></dd></dl></div><p class="subhead_1" id="ID0d00-copyN12"><span class="em">Argument</span></p><div class="textblock"><ul><li><p>Operation mode</p><table><col><col><tr><th valign="top"><p>Mode</p></th><th valign="top"><p>Description</p></th></tr><tr><td align="left" valign="top"><p>prepare</p></td><td align="left" valign="top"><p>Implements the preparation process for backing up using the copy command.</p><p>Called before the PostgreSQL online backup mode is started.</p></td></tr><tr><td align="left" valign="top"><p>backup</p></td><td align="left" valign="top"><p>Implements the backup process.</p><p>Called during the PostgreSQL online backup mode.</p></td></tr><tr><td align="left" valign="top"><p>finalize</p></td><td align="left" valign="top"><p>Implements the backup completion process.</p><p>Called after the PostgreSQL online backup mode is completed.</p></td></tr></table><div class="point"><p class="title">Point</p><div class="pointbody"><p>If using high-speed copy of the storage device (which performs high-speed retrieval of snapshots and copies data to different physical areas), it is possible to invoke the snapshot process in backup mode, and the copy process in finalize mode.</p></div></div></li><li><p>Full path of the backup information file</p><p>Full path of the backup information file of the latest backup, enclosed in single quotation marks. If a backup has not been performed, specify '-'.</p></li><li><p>Full path of the backup target list file</p><p>Full path of the file containing the resources to be backed up using the copy command, enclosed in single quotation marks. One of the following is described in each resource name.</p><table><col><col><tr><th valign="top"><p>Resource</p></th><th valign="top"><p>Description</p></th></tr><tr><td align="left" valign="top"><p>Database cluster</p></td><td align="left" valign="top"><p>pg_data</p></td></tr><tr><td align="left" valign="top"><p>Tablespace</p></td><td align="left" valign="top"><p>Tablespace name</p></td></tr></table><div class="ex"><p class="title">Example</p><div class="exbody"><p>To back up the database cluster and the tablespaces dbspace and indexspace using the copy command, the file should contain the following:</p><pre class="border">pg_datadbspaceindexspace</pre></div></div><div class="tips"><p class="title">Information</p><div class="tipsbody"><p>The encoding of resource names output to the backup target list file by the pgx_dmpall command is the encoding used when this command connects to the database with auto specified for the client_encoding parameter, and is dependent on the locale at the time of command execution.</p></div></div></li></ul><p>The number of arguments vary depending on operation mode. The argument of each operation mode is as follows.</p><table><col><col><col><col><tr><th valign="top"><p>Operation mode</p></th><th valign="top"><p>First argument</p></th><th valign="top"><p>Second argument</p></th><th valign="top"><p>Third argument</p></th></tr><tr><td align="left" valign="top"><p>prepare</p></td><td rowspan="3" align="left" valign="top"><p>Operation mode</p></td><td align="left" valign="top"><p>Backup information file path name</p></td><td align="left" valign="top"><p>Backup target list file path name</p></td></tr><tr><td align="left" valign="top"><p>backup</p></td><td align="left" valign="top"><p>None</p></td><td rowspan="2" align="left" valign="top"><p>None</p></td></tr><tr><td align="left" valign="top"><p>finalize</p></td><td align="left" valign="top"><p>Backup information file path name</p></td></tr></table><p>Additionally, the access permissions for the backup information file and backup target list file are different depending on the operation mode. The access permissions of each operation mode are as follows.</p><table><col><col><col><tr><th valign="top"><p>Operation mode</p></th><th valign="top"><p>Backup information file</p></th><th valign="top"><p>Backup target list file</p></th></tr><tr><td align="left" valign="top"><p>prepare</p></td><td align="left" valign="top"><p>Can be viewed by the instance administrator only</p></td><td align="left" valign="top"><p>Can be viewed by the instance administrator only</p></td></tr><tr><td align="left" valign="top"><p>backup</p></td><td align="left" valign="top"><p>-</p></td><td align="left" valign="top"><p>-</p></td></tr><tr><td align="left" valign="top"><p>finalize</p></td><td align="left" valign="top"><p>Can be viewed and updated by the instance administrator only</p></td><td align="left" valign="top"><p>-</p></td></tr></table></div><p class="subhead_1" id="ID0d00-copyN13"><span class="em">Return value</span></p><div class="textblock"><table><col><col><tr><th valign="top"><p>Return value</p></th><th valign="top"><p>Description</p></th></tr><tr><td align="left" valign="top"><p>0</p></td><td align="left" valign="top"><p>Normal end</p><p>The pgx_dmpall command continues processing.</p></td></tr><tr><td align="left" valign="top"><p>Other than 0</p></td><td align="left" valign="top"><p>Abnormal end</p><p>The pgx_dmpall command terminates in error.</p></td></tr></table></div><p class="subhead_1" id="ID0d00-copyN14"><span class="em">Description</span></p><div class="textblock"><ul><li><p>The copy command operates with the privileges of the operating system user who executed the pgx_dmpall command. Therefore, grant copy command execution privileges to users who will execute the pgx_dmpall command. Additionally, have the copy command change users as necessary.</p></li><li><p>To write to the backup information file, use a method such as redirection from the copy command.</p></li><li><p>Because the copy command is called for each mode, implement all processing for each one.</p></li><li><p>To copy multiple resources simultaneously, have the copy command copy them in parallel.</p></li></ul><div class="note"><p class="title">Note</p><div class="notebody"><ul><li><p>The backup information file and backup target list file cannot be deleted. Additionally, the privileges cannot be changed.</p></li><li><p>Standard output and standard error output of the copy command are output to the terminal where the pgx_dmpall command was executed.</p></li><li><p>If the copy command becomes unresponsive, the pgx_dmpall command will also become unresponsive. If the copy command is deemed to be unresponsive by the operating system, use an operating system command to forcibly stop it.</p></li><li><p>Output the copy command execution trace and the result to a temporary file, so that if it terminates in error, the cause can be investigated at a later time.</p></li><li><p>For prepare mode only, it is possible to use the PostgreSQL client application to access the database using the copy command. For all other modes, do not execute FUJITSU Enterprise Postgres commands or PostgreSQL applications.</p></li><li><p>Enable the fsync parameter in postgresql.conf, because data on the shared memory buffer needs to have been already written to disk when backup starts.</p></li></ul></div></div></div></div><div class="header_footer"><div class="back_next"><a href="j2677-00-14-04-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2677-00-14-04-02.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2015-2021 FUJITSU LIMITED</div></div></body></html>