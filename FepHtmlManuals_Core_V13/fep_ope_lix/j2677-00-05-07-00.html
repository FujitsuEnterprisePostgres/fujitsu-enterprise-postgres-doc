<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>5.7 Backing Up and Restoring/Recovering the Database</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Operation Guide</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="j2677-00-05-00-00.html">Chapter&nbsp;5 Protecting Storage Data Using Transparent Data Encryption</a> &gt; 5.7 Backing Up and Restoring/Recovering the Database</div><div class="back_next"><a href="j2677-00-05-06-04.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2677-00-05-08-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h2 id="br057000">5.7 Backing Up and Restoring/Recovering the Database<a name="N44G"></a></h2><div class="body"><div class="textblock"><p>FUJITSU Enterprise Postgres enables you to use the five backup and recovery methods described below. Regardless of the method you use, you must back up the keystore at the same time.</p><p>Note that you must store the database and the keystore on separate data storage media. Storing both on the same data storage medium risks the danger of the encrypted data being deciphered if the medium is stolen.</p><p></p></div><p class="subhead_1" id="ID05000000N3"><span class="em">Backup and recovery using WebAdmin</span></p><div class="textblock"><ul><li><p>Backup</p><p>WebAdmin backs up encrypted data.</p><p>Back up the key store after backing up the database.</p></li><li><p>Recovery</p><p>Restore the keystore to its state at the time of database backup. Refer to "<a href="j2677-00-05-06-04.html">5.6.4 Backing Up and Recovering the Keystore</a>" for details.</p><p>Enable automatic opening of the keystore in accordance with the procedure described in "<a href="j2677-00-05-06-03.html">5.6.3 Enabling Automatic Opening of the Keystore</a>". Then, use WebAdmin to recover the database.</p></li></ul></div><p class="subhead_1" id="ID05000000N4"><span class="em">Backup and recovery using the pgx_dmpall and pgx_rcvall commands</span><a name="N45G"></a><span class="em"></span></p><div class="textblock"><ul><li><p>Backup</p><p>The pgx_dmpall command backs up the encrypted data.</p><p>Back up the key store after backing up the database.</p></li><li><p>Recovery</p><p>Restore the keystore to its state at the time of the database backup.</p><p>Configure automatic opening of the key store as necessary.</p><p>If automatic opening of the keystore is not enabled, execute the pgx_rcvall command with the --keystore-passphrase option specified. This will display the prompt for the passphrase to be entered.</p></li></ul><div class="ex"><p class="title">Example</p><div class="exbody"><ul><li><p>Back up the database and the keystore on May 1, 2020.</p><pre class="border">&gt; pgx_dmpall -D /database/inst1&gt; cp -p /key/store/location/keystore.ks /keybackup/keystore_20200501.ks</pre><p>Specify the following in the pgx_dmpall command:</p><ul><li><p>Specify the data storage destination in the -D option. If the -D option is omitted, the value of the PGDATA environment variable is used by default.</p></li></ul></li><li><p>Recover the database and the keystore from the backup taken on May 1, 2020.</p><pre class="border">&gt; cp -p /keybackup/keystore_20200501.ks /key/store/location/keystore.ks&gt; pgx_keystore --enable-auto-open /key/store/location/keystore.ks  (Execute only when enabling automatic opening)&gt; pgx_rcvall -B /backup/inst1 -D /database/inst1 --keystore-passphrase</pre><p>Specify the following in the pgx_rcvall command:</p><ul><li><p>Specify the data storage destination in the -D option. If the -D option is omitted, the value of the PGDATA environment variable is used by default.</p></li><li><p>Specify the backup data storage directory in the -B option.</p></li><li><p>The --keystore-passphrase option prompts you to enter the passphrase to open the keystore.</p></li></ul></li></ul></div></div></div><p class="subhead_1" id="ID05000000N5"><span class="em">Dump and restore using SQL</span></p><div class="textblock"><ul><li><p>Backup</p><p>The files output by the pg_dump and pg_dumpall commands are not encrypted. You should, therefore, encrypt the files using OpenSSL commands or other means before saving them, as described in "<a href="j2677-00-05-08-00.html">5.8 Importing and Exporting the Database</a>" below. </p><p>Back up the key store after backing up the database.</p></li><li><p>Restore</p><p>If the backup data has been encrypted using, for example Open SSL commands, decrypt that data.</p><p>The data generated by the pg_dumpall command includes a specification to encrypt tablespaces by default. For this reason, the psql command encrypts tablespaces during restoration.</p></li></ul></div><p class="subhead_1" id="ID05000000N6"><span class="em">File system level backup and restore</span><a name="N46G"></a><span class="em"></span><span class="em"> </span></p><div class="textblock"><ul><li><p>Backup</p><p>Stop the instance and backup the data directory and the tablespace directory using the file copy command of the operating system. The files of encrypted tablespaces are backed up in the encrypted state.</p><p>Back up the key store after performing the backup.</p></li><li><p>Restore</p><p>Restore the keystore to its state at the time of the database backup.</p><p>Stop the instance and restore the data directory and the tablespace directory using the file copy command of the operating system.</p></li></ul></div><p class="subhead_1" id="ID05000000N7"><span class="em">Continuous archiving and point-in-time recovery</span><a name="N47G"></a><span class="em"></span></p><div class="textblock"><ul><li><p>Backup</p><p>The pg_basebackup command backs up the encrypted data as is.</p><p>Back up the key store after performing the backup.</p></li><li><p>Recovery</p><p>Restore the keystore to its state at the time of the database backup.</p><p>Configure automatic opening of the key store as necessary.</p><p>If automatic opening of the keystore is not enabled, execute the pg_ctl command to start the instance with the --keystore-passphrase option specified. This will display the prompt for the passphrase to be entered.</p></li></ul><div class="ref"><p class="title">See</p><div class="refbody"><ul><li><p>Refer to "pg_ctl" under "Reference" in the PostgreSQL Documentation for information on the pg_ctl command.</p></li></ul><ul><li><p>Refer to "Reference" in the PostgreSQL Documentation for information on the following commands:</p><ul><li><p>psql</p></li><li><p>pg_dump</p></li><li><p>pg_basebackup</p></li></ul></li><li><p>Refer to the Reference for information on the following commands:</p><ul><li><p>pgx_rcvall</p></li><li><p>pgx_dmpall</p></li><li><p>pg_dumpall</p></li></ul></li></ul></div></div><p>If you have restored the keystore, repeat the process of enabling automatic opening of the keystore This ensures that the contents of the automatically opening keystore (keystore.aks) are identical to the contents of the restored keystore.</p><p>Refer to "<a href="j2677-00-05-06-03.html">5.6.3 Enabling Automatic Opening of the Keystore</a>" for information on how to enable automatic opening of the keystore.</p></div></div><div class="header_footer"><div class="back_next"><a href="j2677-00-05-06-04.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2677-00-05-08-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2015-2021 FUJITSU LIMITED</div></div></body></html>