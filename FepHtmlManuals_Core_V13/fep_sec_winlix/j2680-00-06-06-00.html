<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>6.4 Session Audit Logging</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Security Operation Guide</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="j2680-00-06-00-00.html">Chapter&nbsp;6 Audit Log Feature</a> &gt; 6.4 Session Audit Logging</div><div class="back_next"><a href="j2680-00-06-04-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2680-00-06-07-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h2 id="mID_06_session">6.4 Session Audit Logging</h2><div class="body"><div class="textblock"><p>In Session Audit Logging, specify the rules for filtering logs to be output in the rule section in the pgaudit configuration file.</p><p>Rules are specified using the formats below. Multiple values can be specified, using a comma as the delimiter.</p><ul><li><p><span class="i">paramName</span> = '<span class="i">value</span>'</p></li><li><p><span class="i">paramName</span> != '<span class="i">value</span>'</p><br></li></ul><p>If [rule] is described on its own in the rule section with no parameters specified, all audit logs will be output.</p><dl><dt class="em">Example</dt><dd><pre class="border">[output]logger = 'auditlog'[rule]</pre></dd></dl><p>If the rule section is not described ([rule] is not described), the audit logs will not be output.</p><dl><dt class="em">Example</dt><dd><pre class="border">[output]logger = 'auditlog'</pre><br></dd></dl><p>The valid parameters in the rule section are shown in the table below.</p><table><col><col><col><tr><th valign="top"><p><span class="em">Parameter name</span></p></th><th valign="top"><p><span class="em">Description</span></p></th><th valign="top"><p><span class="em">Example</span></p></th></tr><tr><td align="left" valign="top"><p>timestamp</p></td><td align="left" valign="top"><p>Timestamp range</p><p>Refer to "<a href="j2680-00-06-06-00.html#mID_06_session_timestamp">timestamp</a>" for details on how to specify timestamps.</p></td><td align="left" valign="top"><p>timestamp = '09:00:00 - 10:00:00, 18:00:00 - 18:30:00'</p></td></tr><tr><td align="left" valign="top"><p>database</p></td><td align="left" valign="top"><p>Database name</p><p>To specify a blank value, use a pair of double quotation marks (""). When specifying a name containing uppercase characters, key words, multibyte characters and commas, enclose the name in double quotation marks.</p></td><td align="left" valign="top"><p>database = 'prodcut_db'</p></td></tr><tr><td align="left" valign="top"><p>audit_role</p></td><td align="left" valign="top"><p>Role name</p><p>To specify a blank value, specify use a pair of double quotation marks (""). When specifying a name containing uppercase characters, key words, multibyte characters and commas, enclose the name in double quotation marks.</p></td><td align="left" valign="top"><p>audit_role = 'appuser1'</p></td></tr><tr><td align="left" valign="top"><p>class</p></td><td align="left" valign="top"><p>Operation class</p><p>Select from the values below. Multiple values can be specified. Refer to "<a href="j2680-00-06-06-00.html#mID_06_session_class">class</a>" for details on the meaning of each class.</p><ul><li><p>BACKUP</p></li><li><p>CONNECT</p></li><li><p>DDL</p></li><li><p>ERROR</p></li><li><p>FUNCTION</p></li><li><p>MISC</p></li><li><p>READ</p></li><li><p>ROLE</p></li><li><p>WRITE</p></li><li><p>SYSTEM</p></li></ul></td><td align="left" valign="top"><p>class = 'READ, WRITE'</p></td></tr><tr><td align="left" valign="top"><p>object_type</p></td><td align="left" valign="top"><p>Object type</p><p>This parameter is enabled when the class parameter is "READ" and "WRITE".</p><p>Select from the values below. Multiple values can be specified.</p><ul><li><p>TABLE</p></li><li><p>INDEX</p></li><li><p>SEQUENCE</p></li><li><p>TOAST_VALUE</p></li><li><p>VIEW</p></li><li><p>MATERIALIZED_VIEW</p></li><li><p>COMPOSITE_TYPE</p></li><li><p>FOREIGN_TABLE</p></li><li><p>FUNCTION</p></li></ul></td><td align="left" valign="top"><p>object_type = 'TABLE, INDEX'</p></td></tr><tr><td align="left" valign="top"><p>object_name</p></td><td align="left" valign="top"><p>Object name</p><p>This parameter is enabled when the class parameter is "READ" and "WRITE".</p><p>For objects that can be modified by a schema, such as a table, modify such objects by schema name.</p><p>When specifying a name containing uppercase characters, key words, multibyte characters and commas, enclose the name in double quotation marks. When specifying the object name "<span class="i">schemaName</span>.<span class="i">tableName</span>", enclose the entire object name modified by schema name in double quotation marks.</p><p>To specify a blank value, use a pair of double quotation marks ("").</p></td><td align="left" valign="top"><p>object_name = 'myschema.tbl1'</p><p>object_name = 'myschema.tbl1, "<span class="i">mySchema</span>.TABLE"'</p></td></tr><tr><td align="left" valign="top"><p>application_name</p></td><td align="left" valign="top"><p>Application name</p><p>To specify a blank value, use a pair of double quotation marks ("").</p></td><td align="left" valign="top"><p>application_name = 'myapp'</p></td></tr><tr><td align="left" valign="top"><p>remote_host</p></td><td align="left" valign="top"><p>Connection destination host name or IP address</p><p>If "on" is specified for the log_hostname parameter in the postgresql.conf file, specify a host name. Otherwise, specify the IP address. If using a local host, specify "[local]".</p><p>To specify a blank value, use a pair of double quotation marks ("").</p></td><td align="left" valign="top"><p>remote_host = 'ap_server'</p></td></tr></table><br><dl><dt class="em" id="mID_06_session_timestamp">timestamp</dt><dd><p>Specify a timestamp range from "<span class="i">startTime</span>" to "<span class="i">endTime</span>" for the log output target. The timestamp format is 'hh:mm:dd-hh:mm:dd' (hh is expressed in 24-hour notation, and hh, mm, and dd are expressed in two-digit notation).</p><p>The start time must be earlier than the end time. If specifying multiple ranges, specify each start and end timestamp using a comma as the delimiter.</p><p>End timestamps consider milliseconds. For example, if '11:00:00 - 11:59:59' is specified for the timestamp, "11:00:00:000" to "11:59:59:999" will be the target range.</p><p>The timestamps used by evaluation in the rule section of pgaudit are different to the timestamps issued in the log entries. That is because log entries are output after evaluation by pgaudit, with the timestamp being generated at that time.</p></dd></dl><dl><dt class="em" id="mID_06_session_class">class</dt><dd><p>The meaning of each class specified in the class parameter is below:</p><ul><li><p>READ: SELECT, COPY FROM</p></li><li><p>WRITE: INSERT, UPDATE, DELETE, TRUNCATE, COPY TO</p></li><li><p>FUNCTION: Function call, DO</p></li><li><p>ROLE: GRANT, REVOKE, CREATE ROLE, ALTER ROLE, DROP ROLE</p></li><li><p>DDL: All DDLs (such as CREATE and ALTER) other than the DDLs of the ROLE class</p></li><li><p>CONNECT: Events relating to connecting (request, authenticate, and disconnect)</p></li><li><p>SYSTEM: Instance start, promotion to primary server</p></li><li><p>BACKUP: pg_basebackup</p></li><li><p>ERROR: Event completed by an error (PostgreSQL error codes other than 00). This class can be used if ERROR or lower level is specified for the log_min_messages parameter in postgresql.conf.</p></li><li><p>MISC: Other commands (such as DISCARD, FETCH, CHECKPOINT, and VACUUM)</p></li></ul></dd></dl><p></p></div><p class="subhead_1" id="IDchap06N7"><span class="em">Evaluation of the rule section</span></p><div class="textblock"><ul><li><p>When a log event occurs, all expressions in the rule section are evaluated at once. Log entries are only output if all parameters in the rule section are evaluated as being true.</p><p>For example, if the rule below has been set, of the operations performed by 'apserver' to 'myschema.tbl1', the operations applicable to classes other than 'WRITE" in the period from 10 a.m. to 11 a.m. will be output as audit logs.</p><pre>[rule]timestamp = '10:00:00-11:00:00'remote_host = 'apserver'object_name = 'myschema.tbl1'class != 'WRITE'</pre><br></li><li><p>Multiple rule sections can be defined in the pgaudit configuration file. Log events are evaluated using each rule section, and an audit log is output for each matching rule section.</p><p>For example, if the rules below are set, duplicated audit logs will be output.</p><pre>[rule]object_name = 'myschema.tbl1'[rule]object_name = 'myschema.tbl1'</pre><br></li><li><p>If the same parameter is specified multiple times in one rule section, the last specified parameter is effective.</p><p>For example, if the rule below has been set, "object_name = 'myschema.tbl3'" will take effect.</p><pre>[rule]object_name = 'myschema.tbl1'object_name = 'myschema.tbl2'object_name = 'myschema.tbl3'</pre></li></ul></div><p class="subhead_1" id="mID_06_session_output"><span class="em">Output format</span></p><div class="textblock"><p>In Session Audit Logging, audit logs are output in the format below:</p><pre class="border">AUDIT: SESSION,READ,2020-03-12 19:00:58 PDT,   (1)         (2)     (3)[local],19944,psql,appuser,postgres,2/8, 2, 1,SELECT,,TABLE,myschema.account, ,  (4)    (5)   (6)   (7)      (8)   (9)(10)(11)(12)(13)(14)    (15)        (16)SELECT * FROM myschema.account;,&lt;not logged&gt;       (17)                      (18)</pre><table><col><col><tr><th valign="top"><p><span class="em">No</span></p></th><th valign="top"><p><span class="em">C</span><span class="em">ontent</span></p></th></tr><tr><td align="left" valign="top"><p>(1)</p></td><td align="left" valign="top"><p>Log header</p><p>Fixed as "AUDIT:<span class="red"> </span>SESSION".</p></td></tr><tr><td align="left" valign="top"><p>(2)</p></td><td align="left" valign="top"><p>Class</p></td></tr><tr><td align="left" valign="top"><p>(3)</p></td><td align="left" valign="top"><p>SQL start time</p></td></tr><tr><td align="left" valign="top"><p>(4)</p></td><td align="left" valign="top"><p>Remote host name</p><p>If using a local host, [local] is output.</p></td></tr><tr><td align="left" valign="top"><p>(5)</p></td><td align="left" valign="top"><p>Backend process ID</p></td></tr><tr><td align="left" valign="top"><p>(6)</p></td><td align="left" valign="top"><p>Application name</p><p>If an application name is not specified, [unknown] is output.</p></td></tr><tr><td align="left" valign="top"><p>(7)</p></td><td align="left" valign="top"><p>User name</p></td></tr><tr><td align="left" valign="top"><p>(8)</p></td><td align="left" valign="top"><p>Database name</p></td></tr><tr><td align="left" valign="top"><p>(9)</p></td><td align="left" valign="top"><p>Virtual transaction ID</p></td></tr><tr><td align="left" valign="top"><p>(10)</p></td><td align="left" valign="top"><p>Statement ID</p></td></tr><tr><td align="left" valign="top"><p>(11)</p></td><td align="left" valign="top"><p>Substatement ID</p></td></tr><tr><td align="left" valign="top"><p>(12)</p></td><td align="left" valign="top"><p>Command tag</p></td></tr><tr><td align="left" valign="top"><p>(13)</p></td><td align="left" valign="top"><p>SQLSTATE</p></td></tr><tr><td align="left" valign="top"><p>(14)</p></td><td align="left" valign="top"><p>Object type</p></td></tr><tr><td align="left" valign="top"><p>(15)</p></td><td align="left" valign="top"><p>Object name</p></td></tr><tr><td align="left" valign="top"><p>(16)</p></td><td align="left" valign="top"><p>Error message</p></td></tr><tr><td align="left" valign="top"><p>(17)</p></td><td align="left" valign="top"><p>SQL</p><p>If the SQL contains a password, such as for CREATE ROLE, and so on, it will be replaced with "&lt;REDACTED&gt;".</p><p>Additionally, if "on" is specified for the log_statement_once parameter of the option section in the pgaudit configuration file, "&lt;previously logged&gt;" is output for the second and subsequent statements.</p></td></tr><tr><td align="left" valign="top"><p>(18)</p></td><td align="left" valign="top"><p>Depending on the log_parameter parameter value of the option section in the pgaudit configuration file, the output content will be as below.</p><ul><li><p>log_parameter=on is specified</p><p>If parameters are specified in the SQL, the parameters are concatenated and output, using a space as the delimiter. <br>If parameters are not specified in the SQL, "&lt;none&gt;" is output.</p></li><li><p>log_parameter=off (default) is specified</p><p>"&lt;not logged&gt;" is output.</p></li></ul><p>Additionally, if "on" is specified for the log_statement_once parameter of the option section in the pgaudit configuration file, "&lt;previously logged&gt;" is output for the second and subsequent statements.</p></td></tr></table><div class="tips"><p class="title">Information</p><div class="tipsbody"><p>If accessing resources that use the features below, the command tag (12) may be output as "???".</p><ul><li><p>INSTEAD OF trigger</p></li><li><p>RULE</p></li><li><p>VIEW</p></li><li><p>Security policy per row</p></li><li><p>Table inheritance</p></li></ul></div></div></div><p class="subhead_1" id="IDchap06N8"><span class="em">Example</span></p><div class="textblock"><p>Below is an example of retrieving audit logs in Session Audit Logging.</p><dl><dt class="em">1. Settings</dt><dd><p>In the pgaudit configuration file, specify the rule section below.</p><pre class="border">[rule]class = 'READ, WRITE'object_name = 'myschema.account'</pre><br></dd></dl><dl><dt class="em">2. Retrieving logs</dt><dd><p>Execute the SQL below from the client.</p><pre class="border">CREATE TABLE myschema.account(    id int,    name text,    password text,    description text);INSERT INTO myschema.account (id, name, password, description) VALUES (1, 'user1', 'HASH1', 'blah, blah');SELECT * FROM myschema.account;</pre><br><p>The audit log below can be retrieved.</p><p>'DDL' is not defined in the class parameter, so CREATE TABLE is not output as an audit log.</p><pre class="border">AUDIT: SESSION,WRITE,2020-03-12 19:00:49 PDT,[local],19944,psql,appuser,postgres,2/7,1,1,INSERT,,TABLE,myschema.account,,"INSERT INTO myschema.account (id, name, password, description) VALUES (1, 'user1', 'HASH1', 'blah, blah');",&lt;not logged&gt;AUDIT: SESSION,READ,2020-03-12 19:00:58 PDT,[local],19944,psql,appuser,postgres,2/8,2,1,SELECT,,TABLE,myschema.account,,SELECT * FROM myschema.account;,&lt;not logged&gt;</pre></dd></dl></div></div><div class="header_footer"><div class="back_next"><a href="j2680-00-06-04-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2680-00-06-07-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2018-2021 FUJITSU LIMITED </div></div></body></html>