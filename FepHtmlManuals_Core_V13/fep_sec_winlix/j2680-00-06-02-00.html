<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>6.2 Setup</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Security Operation Guide</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="j2680-00-06-00-00.html">Chapter&nbsp;6 Audit Log Feature</a> &gt; 6.2 Setup</div><div class="back_next"><a href="j2680-00-06-01-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2680-00-06-04-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h2 id="mID_0602">6.2 Setup</h2><div class="body"><div class="textblock"><p>This section describes the setup method of pgaudit.</p><ol><li><p>Copy the pgaudit files</p><div id="lix" class="spcl"><div class="spcl_body"><p><span class="icon"><img src="image/spcl-lix.gif" width="25" height="18" alt="Linux" title="Linux"></span>As superuser, run the following command. Note that "&lt;<span class="i">x</span>&gt;" in paths indicates the product version.</p></div></div><div id="lix" class="spcl_pre2"><div class="spcl_body"><pre class="border">$ su -Password:******# cp -r /opt/fsepv&lt;<span class="i">x</span>&gt;server64/OSS/pgaudit/* /opt/fsepv&lt;<span class="i">x</span>&gt;server64</pre></div></div><div id="win" class="spcl"><div class="spcl_body"><p><span class="icon"><img src="image/spcl-win.gif" width="25" height="18" alt="Windows" title="Windows"></span>Open a command prompt as administrator privileges, run the following command. Note that "&lt;<span class="i">x</span>&gt;" in paths indicates the product version.</p></div></div><div id="win" class="spcl_pre2"><div class="spcl_body"><pre class="border">&gt; xcopy /E "c:\Program Files\Fujitsu\fsepv&lt;<span class="i">x</span>&gt;server64\OSS\pgaudit\*"  "c:\Program Files\Fujitsu\fsepv&lt;<span class="i">x</span>&gt;server64"</pre></div></div></li><li><p>Create the pgaudit configuration file</p><p>Create the pgaudit configuration file, which describes the information required for pgaudit actions. Create the file using the same encoding as used for the database.</p><p>In addition, set write permissions for the database administrator only in the pgaudit configuration file so that policies related to the audit log are not viewed by unintended users.</p><p>Refer to "<a href="j2680-00-06-04-00.html">6.3 pgaudit Configuration File</a>" for details.</p><div class="note"><p class="title">Note</p><div class="notebody"><p>Do not define the rule section in the pgaudit configuration file at this point.</p></div></div><p><span class="em">Example of a pgaudit configuration </span><span class="em">file</span></p><pre class="border">[output]logger = 'auditlog'</pre></li><li><p>Configure postgresql.conf</p><p>Configure the parameters below in postgresql.conf to use audit logs:</p><dl><dt class="em">shared_preload_libraries</dt><dd><p>Specify "pgaudit".</p></dd></dl><dl><dt class="em">pgaudit.config_file</dt><dd><p>Specify the deployment destination path of the pgaudit configuration file.</p><p>If a relative path is specified, the path will be relative to the data storage directory.</p></dd></dl><dl><dt class="em">log_replication_commands</dt><dd><p>Specify "on".</p></dd></dl><dl><dt class="em">log_min_messages</dt><dd><p>Check if "ERROR" or higher has been specified.</p><br></dd></dl><p>If outputting an audit log to a server log ("serverlog" is specified in the logger parameter of the pgaudit configuration file), check the parameters below relating to server logs.</p><dl><dt class="em">logging_collector</dt><dd><p>Check if "on" has been specified.</p></dd></dl><dl><dt class="em">log_destination</dt><dd><p>Check if "stderr" has been specified.</p></dd></dl><div id="lix" class="spcl_list2"><div class="spcl_body"><dl><dt class="em" id="mID_0602_log_file_mode"><span class="icon"><img src="image/spcl-lix.gif" width="25" height="18" alt="Linux" title="Linux"></span>log_file_mode</dt><dd><div id="lix" class="spcl"><div class="spcl_body"><p>Check if the server log permissions are appropriate, so that only the permitted persons can access it.</p></div></div><div id="lix" class="spcl_list3"><div class="spcl_body"><div class="tips"><p class="title">Information</p><div class="tipsbody"><div id="lix" class="spcl_note_list3"><div class="spcl_body"><p>The default for the log_file_mode parameter is 0600, which only allows the database administrator to have access.</p></div></div><div id="lix" class="spcl_note_list3"><div class="spcl_body"><p>For example, to permit other members of the group to which the database administrator belongs to view the audit logs, specify 0640 for log_file_mode.</p></div></div><div id="lix" class="spcl_note_list3"><div class="spcl_body"><p><span class="em">Example</span></p></div></div><div id="lix" class="spcl_note_pre3"><div class="spcl_body"><pre class="border">log_file_mode = 0640</pre></div></div><div id="lix" class="spcl_note_list3"><div class="spcl_body"><p>The database administrator can also be prevented from viewing audit logs by specifying 0000. However, write privileges are assigned for outputting logs.</p></div></div></div></div></div></div><br></dd></dl></div></div><p>If outputting an audit log to a dedicated log file ("auditlog" is specified in the logger parameter of the pgaudit configuration file), check the parameter below.</p><dl><dt class="em">max_worker_processes</dt><dd><p>If the max_worker_processes parameter has been set, add 1 to the specified value.</p></dd></dl><div class="ref"><p class="title">See</p><div class="refbody"><p>Refer to "Error Reporting and Logging" in the PostgreSQL Documentation for details on server logs.</p><p>If using database multiplexing, refer to "<a href="j2680-00-06-08-00.html">6.6 Database Multiplexing</a>" for details.</p></div></div><p><span class="em">Example of postgresql.conf</span></p><p>In the example below, only the parameters that need to be configured when using the audit log feature are described.</p><pre class="border">shared_preload_libraries = 'pgaudit'pgaudit.config_file = 'pgaudit.conf'log_replication_commands = onlog_min_messages = WARNING</pre></li><li><p>Start the instance</p><p>Start the instance and check if the message below is output.</p><pre class="border">LOG: pgaudit extension initialized</pre></li><li><p>Create the pgaudit extension</p><p>Execute CREATE EXTENSION to create the pgaudit extension.</p><pre class="border">$ psql=# CREATE EXTENSION pgaudit;=# \dx                  List of installed extensionsName    | Version |   Schema   |     Description--------+---------+------------+---------------------------------pgaudit | 1.0     | public     | provides auditing functionalityplpgsql | 1.0     | pg_catalog | PL/pgSQL procedural language(2 rows)</pre></li><li><p>Configure the parameters in the pgaudit configuration file</p><p>Add or change the parameters in the pgaudit configuration file as required.</p><p>Refer to "<a href="j2680-00-06-04-00.html">6.3 pgaudit Configuration File</a>" for details.</p></li><li><p>Restart the instance</p><p>Restart the instance to apply the changes to the pgaudit configuration file. After restarting, check if the changes have been reflected correctly.</p><div id="lix" class="spcl"><div class="spcl_body"><p><span class="icon"><img src="image/spcl-lix.gif" width="25" height="18" alt="Linux" title="Linux"></span><span class="em">Linux</span></p></div></div><div id="lix" class="spcl_pre2"><div class="spcl_body"><pre class="border">LOG:  log_catalog = 1LOG:  log_level_string =LOG:  log_level = 15LOG:  log_parameter = 0LOG:  log_statement_once = 0LOG:  role =LOG:  logger = auditlogLOG:  log_directory = pgaudit_logLOG:  log_filename = pgaudit-%Y-%m-%d_%H%M%S.logLOG:  log_file_mode = 0600LOG:  log_rotation_age = 1440LOG:  log_rotation_size = 10240LOG:  log_truncate_on_rotation = 0LOG:  fifo_directory = /tmpLOG:  Rule 0LOG:  pgaudit extension initialized</pre></div></div><div id="win" class="spcl"><div class="spcl_body"><p><span class="icon"><img src="image/spcl-win.gif" width="25" height="18" alt="Windows" title="Windows"></span><span class="em">Windows</span></p></div></div><div id="win" class="spcl_pre2"><div class="spcl_body"><pre class="border">LOG:  log_catalog = 1LOG:  log_level_string =LOG:  log_level = 15LOG:  log_parameter = 0LOG:  log_statement_once = 0LOG:  role =LOG:  logger = auditlogLOG:  log_directory = pgaudit_logLOG:  log_filename = pgaudit-%Y-%m-%d_%H%M%S.logLOG:  log_file_mode = 0600LOG:  log_rotation_age = 1440LOG:  log_rotation_size = 10240LOG:  log_truncate_on_rotation = 0LOG:  Rule 0LOG:  pgaudit extension initialized</pre></div></div></li></ol><p></p></div></div><div class="header_footer"><div class="back_next"><a href="j2680-00-06-01-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2680-00-06-04-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2018-2021 FUJITSU LIMITED </div></div></body></html>