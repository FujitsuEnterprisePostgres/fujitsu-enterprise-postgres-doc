<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>4.4 Action Required when All Database Servers or Instances Stopped</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Cluster Operation Guide(Database Multiplexing)</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="j2678-00-04-00-00.html">Chapter&nbsp;4 Action Required when an Error Occurs in Database Multiplexing Mode</a> &gt; 4.4 Action Required when All Database Servers or Instances Stopped</div><div class="back_next"><a href="j2678-00-04-03-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2678-00-04-05-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h2 id="mID_0804">4.4 Action Required when All Database Servers or Instances Stopped<a name="N105G"></a></h2><div class="body"><div class="textblock"><p>This section explains what happens when all database servers or instances on the database server have stopped, so jobs cannot continue.</p><div class="ref"><p class="title">See</p><div class="refbody"><p><span class="em">Recovery to database multiplexing mode</span></p><p>Refer to "<a href="j2678-00-04-01-01.html#mID_08010102">4.1.1.2 Rebuild the Standby Server</a>" and "<a href="j2678-00-04-01-01.html#mID_08010103">4.1.1.3 Failback of the Primary Server</a>" for information on recovery to database multiplexing mode.</p></div></div><p>The flow of these recovery operations is shown in the figure below.</p><p class="caption">Figure&nbsp;4.3 Flow of operations</p><p><img src="clust08img/e-0804-ope.gif" alt="" width="720" height="960"></p><p>Perform the following procedure:</p><ol><li><p>Stop the applications</p><p>Stop the applications from running.</p></li><li><p>Identify the primary server</p><p>Use one of the following methods to identify the primary server that was running before the servers or instances stopped:</p><ul><li><p>Refer to the system log on each server and identify the server where the following message was output.</p><pre>Message:</pre><pre class="border">MirroringControllerOpen[30017]: LOG:  promotion processing completed (MCA00062)</pre></li><li><p>On each server, execute the mc_ctl command in status mode to search the servers for which "none(inactivated primary)" is displayed.</p></li></ul></li><li><p>Stop Mirroring Controller on the primary server</p><p>Execute the mc_ctl command in stop mode on the primary server.</p><p>If automatic start and stop of Mirroring Controller has been configured using systemd, do not use the mc_ctl command, but instead use the systemctl command. Refer to "<a href="j2678-00-02-12-00.html">2.12 Setting Automatic Start and Stop of Mirroring Controller and Multiplexed Instances</a>" for details.</p><pre>Example)</pre><pre class="border">$ mc_ctl stop -M /mcdir/inst1</pre><div class="note"><p class="title">Note</p><div class="notebody"><p><span class="em">Forcibly stopping Mirroring Controller</span></p><p>If Mirroring Controller does not stop, specify the -e option in the stop mode of the mc_ctl command and then execute the command.</p><pre>Example)</pre><pre class="border">$ mc_ctl stop -M /mcdir/inst1 -e</pre></div></div></li><li><p>Recover the primary server</p><p>First, refer to "Actions when an Error Occurs" in the Operation Guide, and then identify the cause of the error and perform recovery.</p><p>Next, recover the primary server using the recovery method that uses the pgx_rcvall command based on the backup data.</p><p>If the backup operation was performed using the pgx_dmpall command based on the instructions in "<a href="j2678-00-02-14-02.html">2.14.2 Database Backup Operation</a>", perform the following procedure for the recovery:</p><ol class="alpha"><li><p>Perform the following operations on both the primary server and the standby server, and check the server containing the backup data and the archive log that show the latest date.</p><ul><li><p>Execute the pgx_rcvall command with the -l option specified and identify the backup data that shows the latest date.</p></li><li><p>Identify the archive log that shows the latest date, as shown below.</p><pre>Example)</pre><pre class="border">$ ls -ltr <span class="i">backupDataStorageDir</span>/*_wal</pre></li></ul></li><li><p>If the latest backup data exists on the standby server, copy <span class="inline-note">*1</span> the backup data and overwrite <span class="inline-note">*2</span> it to each backup storage destination directory on the primary server.</p></li><li><p>If the latest archive log and transaction log file exist on the standby server, copy <span class="inline-note">*1</span> the archive log and overwrite <span class="inline-note">*2</span> it to the backup storage destination directory on the primary server.</p></li><li><p>Execute the pgx_rcvall command on the primary server, specifying the backup storage destination directory of the primary server.</p></li></ol><div class="note"><p class="title">Note</p><div class="notebody"><p>*1:  The backup data may contain a symbolic link, so copy the backup data so that the symbolic link is not converted to an ordinary file (with the tar command, for example).</p><p>*2:  If you can save a copy of the backup storage destination directory, do so without overwriting it.</p></div></div><div class="ref"><p class="title">See</p><div class="refbody"><p>Refer to "Actions when an Error Occurs" in the Operation Guide for information on the pgx_rcvall command.</p></div></div></li><li><p>Recover the Mirroring Controller management directory</p><p>Copy the files in the Mirroring Controller management directory from the backup data, and then perform the recovery.</p></li><li><p>Start the primary server instance and Mirroring Controller</p><dl><dt class="em">Enabling automatic switch/disconnection</dt><dd><p>As the instance administrator user, execute the mc_ctl command in start mode.</p><pre>Example)</pre><pre class="border">$ mc_ctl start -M /mcdir/inst1</pre></dd></dl><dl><dt class="em">Disabling automatic switch/disconnection</dt><dd><p>As the instance administrator user, execute the mc_ctl command in start mode with the -F option specified.</p><pre>Example)</pre><pre class="border">$ mc_ctl start -M /mcdir/inst1 -F</pre></dd></dl><div class="point"><p class="title">Point</p><div class="pointbody"><p>After Mirroring Controller is started, automatic switch/disconnection can be enabled or disabled using the enable-failover or disable-failover mode of the mc_ctl command.</p></div></div></li><li><p>Resume applications</p><p>Resume the applications.</p></li><li><p>Stop Mirroring Controller on the standby server</p><p>Execute the mc_ctl command in stop mode on the standby server.</p><p>If automatic start and stop of Mirroring Controller has been configured using systemd, do not use the mc_ctl command, but instead use the systemctl command. Refer to "<a href="j2678-00-02-12-00.html">2.12 Setting Automatic Start and Stop of Mirroring Controller and Multiplexed Instances</a>" for details.</p><pre>Example)</pre><pre class="border">$ mc_ctl stop -M /mcdir/inst1</pre></li><li><p>Recover the standby server</p><p>Refer to "<a href="j2678-00-02-05-02.html">2.5.2 Creating, Setting, and Registering the Standby Server Instance</a>", and then recover (set up) the standby server from the primary server.</p></li><li><p>Rebuild the standby server</p><p>On the standby server, start Mirroring Controller and the instance.</p><dl><dt class="em">Enabling automatic switch/disconnection</dt><dd><p>As the instance administrator user, execute the mc_ctl command in start mode.</p><pre>Example)</pre><pre class="border">$ mc_ctl start -M /mcdir/inst1</pre></dd></dl><dl><dt class="em">Disabling automatic switch/disconnection</dt><dd><p>As the instance administrator user, execute the mc_ctl command in start mode with the -F option specified.</p><pre>Example)</pre><pre class="border">$ mc_ctl start -M /mcdir/inst1 -F</pre></dd></dl><div class="point"><p class="title">Point</p><div class="pointbody"><p>After Mirroring Controller is started, automatic switch/disconnection can be enabled or disabled using the enable-failover or disable-failover mode of the mc_ctl command.</p></div></div></li></ol><p></p></div></div><div class="header_footer"><div class="back_next"><a href="j2678-00-04-03-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2678-00-04-05-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2016-2021 FUJITSU LIMITED</div></div></body></html>