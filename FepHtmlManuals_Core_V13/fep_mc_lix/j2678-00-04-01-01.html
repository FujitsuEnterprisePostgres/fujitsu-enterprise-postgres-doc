<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>4.1.1 Operations when the Server has Started Degrading after a Switch has Occurred</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Cluster Operation Guide(Database Multiplexing)</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="j2678-00-04-00-00.html">Chapter&nbsp;4 Action Required when an Error Occurs in Database Multiplexing Mode</a> &gt; <a href="j2678-00-04-01-00.html">4.1 Action Required when Server Degradation Occurs</a> &gt; 4.1.1 Operations when the Server has Started Degrading after a Switch has Occurred</div><div class="back_next"><a href="j2678-00-04-01-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2678-00-04-01-02.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h3 id="mID_080101">4.1.1 Operations when the Server has Started Degrading after a Switch has Occurred<a name="N89G"></a></h3><div class="body"><div class="textblock"><p>This section explains the operations when the server has started degrading after a switch has occurred.</p><div class="note"><p class="title">Note</p><div class="notebody"><ul><li><p>After a switch has occurred as a result of an abnormality on the primary server, the database will not have a multiplexed configuration until the standby server is rebuilt. Remove the cause of the error as quickly as possible, and then rebuild the standby server.</p></li><li><p>If the reference job was executed on the standby server, and the servers are switched because an error occurred on the primary server, the load is concentrated on the new primary server. Accordingly, pause the reference job on the original standby server, rebuild the original primary server as the new standby server, and then resume the reference job for the new standby server.</p></li><li><p>If the instance on the new primary server is stopped before the original primary server where the error occurred is rebuilt as the new standby server, a split brain occurs at startup from the instance on the original primary server. Therefore, start the instance on the new primary server before rebuilding the standby server.</p></li></ul></div></div><p>If the switch occurred and the server has started degrading, perform the following operations to recover the standby server and revert it to its original state:</p><ul><li><p><a href="j2678-00-04-01-01.html#mID_08010101"><span class="u">Identify Cause of Error and </span><span class="u">Re</span><span class="u">store</span><span class="u"> the Standby Server</span></a></p></li><li><p><a href="j2678-00-04-01-01.html#mID_08010102"><span class="u">Rebuild the Standby Server</span></a></p></li><li><p><a href="j2678-00-04-01-01.html#mID_08010103"><span class="u">Failback of the Primary Server</span></a> (only if required)</p></li></ul><p>The flow of these operations is shown in the figure below.</p><p class="caption">Figure&nbsp;4.1 Flow of operations</p><p><img src="clust08img/e-0801-fb1.gif" alt="" width="720" height="762"></p><p></p></div></div><h4 id="mID_08010101">4.1.1.1 Identify Cause of Error and Restore the Standby Server<a name="N90G"></a></h4><div class="body"><div class="textblock"><p>Perform the recovery according to the following procedure:</p><ol><li><p><a href="j2678-00-04-01-01.html#mID_0801010101"><span class="u">Stop Mirroring Controller</span></a></p></li><li><p><a href="j2678-00-04-01-01.html#mID_0801010102"><span class="u">Recovery of the Mirroring Controller management directory</span></a></p></li><li><p><a href="j2678-00-04-01-01.html#mID_0801010103"><span class="u">Identify cause of error and perform recovery</span></a></p></li></ol></div></div><h5 id="mID_0801010101">4.1.1.1.1 Stop Mirroring Controller<a name="N91G"></a></h5><div class="body"><div class="textblock"><p>Execute the mc_ctl command in stop mode for the original primary server on which the error occurred. </p><p>If automatic start and stop of Mirroring Controller has been configured using systemd, do not use the mc_ctl command, but instead use the systemctl command. Refer to "<a href="j2678-00-02-12-00.html">2.12 Setting Automatic Start and Stop of Mirroring Controller and Multiplexed Instances</a>" for details.</p><pre>Example)</pre><pre class="border">$ mc_ctl stop -M /mcdir/inst1</pre><p>This also stops the instance that is required to perform the recovery.</p><div class="note"><p class="title">Note</p><div class="notebody"><p>If the instance does not stop, refer to "Actions in Response to Failure to Stop an Instance" in the Operation Guide, and then stop the instance.</p><p>Then, specify the -e option in the above command to forcibly stop Mirroring Controller.</p></div></div></div></div><h5 id="mID_0801010102">4.1.1.1.2 Recovery of the Mirroring Controller management directory<a name="N92G"></a></h5><div class="body"><div class="textblock"><p>Copy the files in the Mirroring Controller management directory from the backup data, and then perform the recovery.</p></div></div><h5 id="mID_0801010103">4.1.1.1.3 Identify cause of error and perform recovery<a name="N93G"></a></h5><div class="body"><div class="textblock"><p>Refer to the system log of the primary server and the standby server to identify the cause of the error, and then perform recovery.</p><p>The following commands can be used to recover a standby server. Select depending on the recovery and the situation.</p><ul><li><p>pg_basebackup</p><p>Creates a copy of all resources of the primary server instance.</p></li><li><p>pg_rewind</p><p>Creates a copy of only the updated files on the new primary server. For this reason, if this command is used to incorporate a new standby server, recovery time can be shortened. To use this command to build the original primary server as a new standby server, at least one of the following must be met:</p><ol class="alpha"><li><p>Checksums were enabled when an instance was created, or</p></li><li><p>The wal_log_hints parameter of postgresql.conf was enabled when an instance was started.</p></li></ol><p>Additionally, full_page_writes must be enabled, which is its default value.</p></li></ul><div class="ref"><p class="title">See</p><div class="refbody"><ul><li><p>Refer to "pg_basebackup" in "Reference" in the PostgreSQL Documentation for information on the pg_basebackup command.</p></li><li><p>Refer to "pg_rewind" in "Reference" in the PostgreSQL Documentation for information on the pg_rewind command.</p></li></ul></div></div><p>The example below executes the pg_rewind command to perform recovery by synchronizing data on the original primary server with the new primary server.</p><ol><li><p>Wait for the application of unapplied update transaction logs on the new primary server.</p><p>Execute the SQL below on the new primary server, and wait until the result is false.</p><pre class="border"># select pg_is_in_recovery();</pre><pre>Example)</pre><pre class="border">$ psql -h <span class="i">hostNameOfNewPrimaryServer</span> -p <span class="i">portN</span><span class="i">um</span><span class="i">OfNewPrimaryServer</span> -d <span class="i">d</span><span class="i">b</span><span class="i">Name</span> -c "select pg_is_in_recovery();"</pre><p>Any database can be connected to.</p><div class="note"><p class="title">Note</p><div class="notebody"><p>If the pg_rewind command is executed immediately after promotion of the new primary server, the processing in steps 1 and 2 is required. If update-type SQL can be executed on the new primary server and checkpoint processing is executed after promotion, the processing in steps 1 and 2 will not be necessary.</p></div></div></li><li><p>Update the timeline ID.</p><p>Execute checkpoint processing, and update the timeline ID.</p><pre class="border">$ psql -h <span class="i">hostNameOfNewPrimaryServer</span> -p <span class="i">portN</span><span class="i">um</span><span class="i">OfNewPrimaryServer</span> -d <span class="i">d</span><span class="i">b</span><span class="i">Name</span> -c "checkpoint;"</pre><p>Any database can be connected to.</p></li><li><p>Create a copy of the new primary server instance in the original primary server (new standby server).</p><p>Execute the pg_rewind command to synchronize the new standby server data with the new primary server.</p><pre>Example)</pre><pre class="border">$ pg_rewind -D /database/inst1 -R --source-server='user=<span class="i">userName</span> host=<span class="i">newPrimaryServerHostName</span> port=<span class="i">newPrimaryServerPortNumber</span> dbname=<span class="i">d</span><span class="i">b</span><span class="i">Name</span> application_name=<span class="i">newStandbyServerName</span>'</pre><div class="note"><p class="title">Note</p><div class="notebody"><ul><li><p>Use the pg_rewind command with the -R option to create a standby.signal file. If you do not create the standby.signal file, the Mirroring Controller cannot be started as a standby server.</p></li><li><p>If using a method that requires password authentication for connections to the primary server, you will need to ensure that authentication is performed automatically. If the -R option is specified for the pg_rewind command and the password parameter is specified for the --dbname option, the pg_rewind command will set the password in the primary_conninfo parameter in postgresql.auto.conf file, enabling connections to be performed automatically.</p><p>If a password is not set in the primary_conninfo parameter in postgresql.auto.conf file, it will be necessary to create a .pgpass file in the home directory of the instance administrator user, and specify a password for the replication database.</p></li><li><p>If you need to set a connection string other than host, port and application_name, include it in the setting of the primary_conninfo parameter.</p></li><li><p>The primary_conninfo parameter should not be set in the postgresql.conf file, but only in the postgresql.auto.conf file using the pg_rewind command.</p></li></ul></div></div></li><li><p>Specify parameters in the postgresql.conf file of the original primary server (new standby server).</p><p>Set the parameters required for the standby server in postgresql.conf.</p><p>Refer to "<a href="j2678-00-02-05-02.html#mID_060402_conf_table">Table&nbsp;2.5 Parameters</a>" for information on the parameters to set in postgresql.conf.</p></li></ol><div class="ref"><p class="title">See</p><div class="refbody"><ul><li><p>Refer to "Hot Standby" in the PostgreSQL Documentation for details on the standby.signal file.</p></li><li><p>Refer to "Setting Up a Standby Server" in the PostgreSQL Documentation for details on the primary_conninfo.</p></li></ul></div></div><div class="note"><p class="title">Note</p><div class="notebody"><p>A new timeline is branched for the new primary server due to promotion, so 'latest' needs to be specified for the recovery_target_timeline parameter so that the old primary server (new standby server) follows the new primary server.</p></div></div></div></div><h4 id="mID_08010102">4.1.1.2 Rebuild the Standby Server<a name="N94G"></a></h4><div class="body"><div class="textblock"><p>The starting of the recovered original primary server as the standby server is referred to as the "standby server rebuild".</p><p>On the original primary server, start Mirroring Controller and the instance.</p><dl><dt class="em">Enabling automatic switch/disconnection</dt><dd><p>As the instance administrator user, execute the mc_ctl command in start mode.</p><pre>Example)</pre><pre class="border">$ mc_ctl start -M /mcdir/inst1</pre></dd></dl><dl><dt class="em">Disabling automatic switch/disconnection</dt><dd><p>As the instance administrator user, execute the mc_ctl command in start mode with the -F option specified.</p><pre>Example)</pre><pre class="border">$ mc_ctl start -M /mcdir/inst1 -F</pre></dd></dl><div class="point"><p class="title">Point</p><div class="pointbody"><p>After Mirroring Controller is started, automatic switch/disconnection can be enabled or disabled using the enable-failover or disable-failover mode of the mc_ctl command.</p></div></div></div></div><h4 id="mID_08010103">4.1.1.3 Failback of the Primary Server<a name="N95G"></a></h4><div class="body"><div class="textblock"><p>To revert the primary server and standby server to the original server configuration after rebuilding the standby server, perform failback for the primary server.</p><p>Do this to execute the main job on the previous primary server.</p><p>Perform the following procedure:</p><ol><li><p>Failback of the primary server</p><p>Execute the mc_ctl command in switch mode on the primary server or the standby server.</p><pre>Example)</pre><pre class="border">$ mc_ctl switch -M /mcdir/inst1</pre><p>After executing the mc_ctl command in switch mode, the status will be as follows:</p><pre>Example)</pre><pre class="border">$ mc_ctl status -M /mcdir/inst1mirroring status----------------switchedserver_id  host_role                    host          host_status  db_proc_status        disk_status----------------------------------------------------------------------------------------------server1    primary                   192.0.2.100 normal        abnormal(postmaster) normalserver2    none(inactivated primary) 192.0.2.110 normal        abnormal(postmaster) normal</pre></li><li><p>Stop the original primary server</p><p>On the original primary server, execute the mc_ctl command in stop mode to stop Mirroring Controller and the instance.</p><p>If automatic start and stop of Mirroring Controller has been configured using systemd, do not use the mc_ctl command, but instead use the systemctl command. Refer to "<a href="j2678-00-02-12-00.html">2.12 Setting Automatic Start and Stop of Mirroring Controller and Multiplexed Instances</a>" for details.</p><pre>Example)</pre><pre class="border">$ mc_ctl stop -M /mcdir/inst1</pre></li><li><p>Create a copy of the new primary server instance in the original primary server (new standby server)</p><p>Execute the pg_basebackup command to create data in the new standby server by synchronizing with the new primary server.</p><pre>Example)</pre><pre class="border">$ pg_basebackup -D /database/inst1 -X fetch --waldir=/transaction/inst1 --progress --verbose -R --dbname='application_name=<span class="i">standbyServerName</span>' -h <span class="i">primaryServerHostName</span> -p <span class="i">primaryServerPortNumber</span></pre><div class="ref"><p class="title">See</p><div class="refbody"><p>The procedure for copying the new primary server instance to the new standby server is the same as the procedure for setting up the new standby server.</p><p>Refer to "<a href="j2678-00-02-05-02.html">2.5.2 Creating, Setting, and Registering the Standby Server Instance</a>", and then perform the recovery.</p></div></div></li><li><p>Rebuild the standby server</p><p>On the standby server, start Mirroring Controller and the instance.</p><dl><dt class="em">Enabling automatic switch/disconnection</dt><dd><p>As the instance administrator user, execute the mc_ctl command in start mode.</p><pre>Example)</pre><pre class="border">$ mc_ctl start -M /mcdir/inst1</pre></dd></dl><dl><dt class="em">Disabling automatic switch/disconnection</dt><dd><p>As the instance administrator user, execute the mc_ctl command in start mode with the -F option specified.</p><pre>Example)</pre><pre class="border">$ mc_ctl start -M /mcdir/inst1 -F</pre></dd></dl><div class="point"><p class="title">Point</p><div class="pointbody"><p>After Mirroring Controller is started, automatic switch/disconnection can be enabled or disabled using the enable-failover or disable-failover mode of the mc_ctl command.</p></div></div></li></ol></div></div><div class="header_footer"><div class="back_next"><a href="j2678-00-04-01-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2678-00-04-01-02.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2016-2021 FUJITSU LIMITED</div></div></body></html>