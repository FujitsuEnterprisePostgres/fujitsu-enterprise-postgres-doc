<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>11.1.2 Locked Statistics</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Application Development Guide</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="j2681-00-11-00-00.html">Chapter&nbsp;11 Performance Tuning</a> &gt; <a href="j2681-00-11-01-00.html">11.1 Enhanced Query Plan Stability</a> &gt; 11.1.2 Locked Statistics</div><div class="back_next"><a href="j2681-00-11-01-01.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2681-00-12-00-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h3 id="mID_110102">11.1.2 Locked Statistics</h3><div class="body"><div class="textblock"><p>This section explains the basic feature content for locked statistics (pg_dbms_stats).</p><p>Refer to the open-source software webpage for information on pg_dbms_stats.</p><p></p></div><p class="subhead_1" id="IDapl11N5"><span class="em">Description</span></p><div class="textblock"><p>Locks the statistics.</p><p>By using this feature to lock the statistics for performance obtained in job load testing in an environment that simulates a production environment, performance degradation caused by changes to the query plan after go-live can be suppressed.</p><p>Additionally, by using the export and import features, statistics that were checked in the test environment can also be reproduced in the production environment.</p></div><p class="subhead_1" id="IDapl11N6"><span class="em">List of Features</span></p><div class="textblock"><p>The main features that can be specified using this feature are as follows.</p><p><span class="em">[Features]</span></p><table><col><col><col><tr><th valign="top"><p><span class="em">Feature</span></p></th><th valign="top"><p><span class="em">Details</span></p></th><th valign="top"><p><span class="em">Description</span></p></th></tr><tr><td rowspan="2" align="left" valign="top"><p>Lock/unlock of the statistics</p></td><td align="left" valign="middle"><p>Lock</p></td><td align="left" valign="middle"><p>Locks the statistics so that the currently selected query plan remains selected.</p></td></tr><tr><td align="left" valign="middle"><p>Unlock</p></td><td align="left" valign="middle"><p>Unlocks the statistics.</p></td></tr><tr><td rowspan="3" align="left" valign="top"><p>Backup/restore of the statistics</p></td><td align="left" valign="middle"><p>Backup</p></td><td align="left" valign="middle"><p>Backs up the current statistics.</p></td></tr><tr><td align="left" valign="middle"><p>Restore</p></td><td align="left" valign="middle"><p>Restores the statistics to the point when they were backed up, and then locks them.</p></td></tr><tr><td align="left" valign="middle"><p>Purge</p></td><td align="left" valign="middle"><p>Deletes backups that are no longer necessary.</p></td></tr><tr><td rowspan="2" align="left" valign="top"><p>Backup/restore using external files</p></td><td align="left" valign="middle"><p>Export</p></td><td align="left" valign="middle"><p>Outputs the current statistics to an external file (binary format).</p></td></tr><tr><td align="left" valign="middle"><p>Import</p></td><td align="left" valign="middle"><p>Reads the statistics from an external file created by the export feature, and then locks them.</p></td></tr></table><br><p><span class="em">[Target object]</span></p><table><col><col><tr><th valign="top"><p><span class="em">Target resource</span></p></th><th valign="top"><p><span class="em">Range of feature</span></p></th></tr><tr><td align="left" valign="middle"><p>Database</p></td><td align="left" valign="middle"><p>In the database</p></td></tr><tr><td align="left" valign="middle"><p>Schema</p></td><td align="left" valign="middle"><p>In the schema</p></td></tr><tr><td align="left" valign="middle"><p>Table</p></td><td align="left" valign="middle"><p>In the table</p></td></tr><tr><td align="left" valign="middle"><p>Column</p></td><td align="left" valign="middle"><p>ID column</p></td></tr></table></div><p class="subhead_1" id="IDapl11N7"><span class="em">Usage method</span></p><div class="textblock"><p>The use of this feature is explained below.</p><br><dl><dt class="em">Method used to specify this feature</dt><dd><p>Specify this feature as an SQL function.</p><p>The methods used to specify the main features are shown in the table below.</p><table><col><col><col><tr><th valign="top"><p><span class="em">Feature</span></p></th><th valign="top"><p><span class="em">Object</span></p></th><th valign="top"><p><span class="em">Function specified</span></p></th></tr><tr><td rowspan="3" align="left" valign="top"><p>Lock</p></td><td align="left" valign="middle"><p>Database</p></td><td align="left" valign="middle"><p>dbms_stats.lock_database_stats()</p></td></tr><tr><td align="left" valign="middle"><p>Schema</p></td><td align="left" valign="middle"><p>dbms_stats.lock_schema_stats('<span class="i">schema</span><span class="i">N</span><span class="i">ame</span>')</p></td></tr><tr><td align="left" valign="middle"><p>Table</p></td><td align="left" valign="middle"><p>dbms_stats.lock_table_stats('<span class="i">schema</span><span class="i">N</span><span class="i">ame</span>.<span class="i">table</span><span class="i">N</span><span class="i">ame</span>')</p></td></tr><tr><td rowspan="3" align="left" valign="top"><p>Unlock</p></td><td align="left" valign="middle"><p>Database</p></td><td align="left" valign="middle"><p>dbms_stats.unlock_database_stats()</p></td></tr><tr><td align="left" valign="middle"><p>Schema</p></td><td align="left" valign="middle"><p>dbms_stats.unlock_schema_stats('<span class="i">schemaName</span>')</p></td></tr><tr><td align="left" valign="middle"><p>Table</p></td><td align="left" valign="middle"><p>dbms_stats.unlock_table_stats('<span class="i">schemaName</span>.<span class="i">tableName</span>')</p></td></tr><tr><td align="left" valign="top"><p>Import</p></td><td align="left" valign="top"><p>Database</p></td><td align="left" valign="middle"><p>dbms_stats.import_database_stats('<span class="i">fullPathOfExportedFile</span>')</p></td></tr><tr><td align="left" valign="top"><p>Backup</p></td><td align="left" valign="middle"><p>Database</p></td><td align="left" valign="middle"><p>dbms_stats.backup_database_stats('<span class="i">comment</span><span class="i">U</span><span class="i">sed</span><span class="i">F</span><span class="i">or</span><span class="i">I</span><span class="i">dentification</span>')</p></td></tr><tr><td align="left" valign="top"><p>Restore</p></td><td align="left" valign="top"><p>Database</p></td><td align="left" valign="top"><p>[Format 1]<br>dbms_stats.restore_database_stats('<span class="i">timestamp</span>')</p><p>[Timestamp]<br>Specify in the same format as the time column of the backup_history table. Backups earlier than the specified time will be restored.</p><p>[Format 2]<br>dbms_stats.restore_stats(<span class="i">backupId</span>)</p><p>[Backup ID]<br>Specify a value in the id column of the backup_history table. The specified backup will be restored.</p></td></tr><tr><td align="left" valign="top"><p>Purge</p></td><td align="left" valign="top"><p>Backup</p></td><td align="left" valign="top"><p>dbms_stats.purge_stats(<span class="i">backupI</span><span class="i">d</span><span class="i">,flag</span><span class="i">U</span><span class="i">sed</span><span class="i">F</span><span class="i">or</span><span class="i">D</span><span class="i">eletion</span>)</p><p>[Backup ID]<br>Specify a value in the id column of the backup_history table.</p><p>[Flag used for deletion]<br>true: The target backup is forcibly deleted.<br>false: The target backup is deleted only when there are also backups for the entire database.</p></td></tr></table><p class="supple">Remark 1: The export feature is executed using the COPY statement, not the SQL function.</p><br><div class="ex"><p class="title">Example</p><div class="exbody"><p><span class="em">Example </span><span class="em">1: </span><span class="em">Locking the statistics of the entire database</span></p><pre class="border">userdb=# SELECT dbms_stats.lock_database_stats();  lock_database_stats  -----------------------  tbl1   tbl1_pkey</pre><p>Note that the locked information can be referenced as follows:</p><pre class="border">userdb=# select relname  from dbms_stats.relation_stats_locked;  relname-----------------------  tbl1   tbl1_pkey</pre><br><p><span class="em">Example 2</span><span class="em">: </span><span class="em">Unlocking the statistics of the entire database</span></p><pre class="border">userdb=# SELECT dbms_stats.unlock_database_stats();  unlock_database_stats  -----------------------  tbl1   tbl1_pkey</pre><br><p><span class="em">Example 3</span><span class="em">: </span><span class="em">Backing up the statistics of the entire database</span></p><pre class="border">userdb=# SELECT dbms_stats.backup_database_stats('backup1');  backup_database_stats -----------------------                     1</pre><p>Note that the backed up statistics can be referenced as follows:</p><pre class="border">userdb=# select id,comment,time,unit from dbms_stats.backup_history;  id | comment  |             time              | unit ----+----------+-------------------------------+------   1 | backup1  | 2014-03-04 11:08:40.315948+09 | d</pre><p>The ID:1 backup "backup1" is obtained for each database at "2014-03-04 11:08:40.315948+09".<br>[Meaning of unit] d: database  s: schema  t: table  c: column</p><br><p><span class="em">Example 4</span><span class="em">: </span><span class="em">Exporting the statistics of the entire database</span></p><pre class="border">$ psql -d userdb -f export.sqlBEGINCOMMIT</pre><p>export.sql is the file in which the COPY statement is defined.<br>Refer to "export_effective_stats-&lt;<span class="i">x</span>&gt;.sql_sample" for information on the content of the COPY statement. "&lt;<span class="i">x</span>&gt;" indicates the product version.</p><p>"export_effective_stats-&lt;<span class="i">x</span>&gt;.sql_sample" is stored as follows:<br><span class="i">fujitsuEnterprise</span><span class="i">Postgres</span><span class="i">InstallDir</span>/share/doc/extension</p><br><p><span class="em">Example 5</span><span class="em">: </span><span class="em">Importing the statistics of the entire database</span></p><pre class="border">$ psql -d userdb -c  "SELECT dbms_stats.import_database_stats ('$PWD/export_stats.dmp')"  import_database_stats ----------------------- (1 row)</pre></div></div></dd></dl></div><p class="subhead_1" id="IDapl11N8"><span class="em">Usage notes</span></p><div class="textblock"><ul><li><p>You must run the ANALYZE command once for the target tables of this feature. If the ANALYZE command is not run, the statistics cannot be locked.<br>Refer to "SQL Commands" in "Reference" in the PostgreSQL Documentation for information on the ANALYZE command.</p></li><li><p>To use this feature to delete an object that has locked the statistics, use the unlock feature to delete the object lock information first.</p></li><li><p>This feature does not specify the statistics value directly. It reproduces the status that has actually occurred. For this reason, if the text format is specified in the COPY statement when the export occurs, restore will not be possible. Always use the binary format when performing the export.</p></li></ul></div></div><div class="header_footer"><div class="back_next"><a href="j2681-00-11-01-01.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2681-00-12-00-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2015-2021 FUJITSU LIMITED</div></div></body></html>