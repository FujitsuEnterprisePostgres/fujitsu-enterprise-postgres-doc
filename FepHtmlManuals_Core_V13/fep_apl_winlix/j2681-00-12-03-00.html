<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>12.3 Usage Notes</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Application Development Guide</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="j2681-00-12-00-00.html">Chapter&nbsp;12 Scan Using a Vertical Clustered Index (VCI)</a> &gt; 12.3 Usage Notes</div><div class="back_next"><a href="j2681-00-12-02-04.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2681-a-00-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h2 id="IDapl13N5">12.3 Usage Notes</h2><div class="body"><div class="textblock"><p>This section provides notes on using VCI.</p><ul><li><p>Regardless of whether VCI is used, the content of the result does not change. However, records may be returned in a different order if the ORDER BY clause is not specified.</p></li><li><p>To reduce resource consumption, edit postgresql.conf or use the SET statement to enable/disable vci.enable when you use this feature only for specific times or jobs (SQL applications).</p></li><li><p>The optimizer hint (pg_hint_plan) cannot be specified for a VCI. The hint clause is ignored if it is specified.</p></li><li><p>If a plan other than VCI is specified for the optimizer hint (pg_hint_plan), a VCI may be used. Therefore, if you specify a query plan with the hint clause, use the SET statement to set vci.enable to "off".</p></li><li><p>The message below may be output when a scan that uses VCI is performed on the streaming replication standby server:</p><pre class="border">"LOG: recovery has paused""HINT: Execute pg_wal_replay_resume() to continue."</pre><p>This message is output because application of the WAL to the VCI temporarily pauses due to the scan being performed.</p></li><li><p>Even if a scan is performed using a VCI, information in the idx_scan, idx_tup_read, and idx_tup_fetch columns of the collected statistics views, pg_stat_all_indexes and pg_stat_user_indexes, will not be updated.</p></li><li><p>Currently, it is not possible to replace the query plan for parallel aggregation with the query plan using VCI. Therefore, if you create a VCI on a column of a partition table and aggregate (sum () etc.) on that column, one of the following plans will be selected. Use different setting parameters according to the situation of the target table.</p><ul><li><p>Plan of the parallel aggregations using scan methods other than VCI scan</p><p>It is selected when max_parallel_workers_per_gather is 1 or more.</p><pre class="border">explain select sum(value) from test;                                         QUERY PLAN----------------------------------------------------------------------------------- Finalize Aggregate  (cost=99906.30..99906.31 rows=1 width=8)   -&gt;  Gather  (cost=99906.08..99906.29 rows=2 width=8)         Workers Planned: 2         -&gt;  Partial Aggregate  (cost=98906.08..98906.09 rows=1 width=8)               -&gt;  Parallel Append  (cost=0.00..94739.83 rows=1666500 width=4)                     -&gt;  Parallel Seq Scan on test_1  (cost=0.00..43203.67 rows=833250 width=4)                     -&gt;  Parallel Seq Scan on test_2  (cost=0.00..43203.67 rows=833250 width=4)</pre><p>This plan is fast when the number of records to be aggregated (number of records that hit the search conditions) is very large. This is because the benefit of parallelizing aggregation is important, not the performance of scanning. For example, each parallel worker will perform a sequential scan and aggregate most of the scanned records.</p></li><li><p>Plan that aggregates VCI scan results by a single aggregator node</p><p>It is selected by setting max_parallel_workers_per_gather to 0 and not creating a query plan of parallel aggregate.</p><pre class="border">explain select sum(value) from test;                                        QUERY PLAN----------------------------------------------------------------------------------- Aggregate  (cost=145571.00..145571.01 rows=1 width=8)   -&gt;  Append  (cost=0.00..135572.00 rows=3999600 width=4)         -&gt;  Custom Scan (VCI Scan) using test_1_id_value_idx on test_1  (cost=0.00..57787.00 rows=1999800 width=4)               Allocated Workers: 2         -&gt;  Custom Scan (VCI Scan) using test_2_id_value_idx on test_2  (cost=0.00..57787.00 rows=1999800 width=4)               Allocated Workers: 2</pre><p>This plan is fast when the number of aggregated items is not large or when the size of the aggregated column is smaller than the record size. This is because the scan performance is more important, so it is faster to aggregate the results of VCI scans of each partition.</p></li></ul></li><li><p>Originally, if there is only one partition to be accessed, the following VCI aggregation plan can be used. Below is an example of scanning only one partition with partition pruning.</p><pre class="border">explain select sum(value) from test where id &lt; 1000001;                                        QUERY PLAN-------------------------------------------------------------------------------------- Custom Scan (VCI Aggregate)  (cost=62786.50..62786.51 rows=1 width=8)   Allocated Workers: 2   -&gt;  Custom Scan (VCI Scan) using test_1_id_value_idx on test_1  (cost=0.00..57787.00 rows=1999800 width=4)         Filter: (id &lt; 1000001)</pre><p>However, the current planner does not try to choose VCI aggregation because it creates a plan for parallel aggregation if the table is partitioned. So in this case, set max_parallel_workers_per_gather to 0 to force the planner to choose VCI aggregation.</p></li></ul><p></p></div></div><div class="header_footer"><div class="back_next"><a href="j2681-00-12-02-04.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2681-a-00-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2015-2021 FUJITSU LIMITED</div></div></body></html>