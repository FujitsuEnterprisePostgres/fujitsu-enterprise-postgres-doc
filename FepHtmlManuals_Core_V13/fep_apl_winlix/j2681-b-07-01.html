<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><META CONTENT="4.3" NAME="GeneratorVersion"><title>B.7.1 Searching Using a Cursor</title><link rel="stylesheet" href="manualmain.css" type="TEXT/CSS"><script language="JavaScript" src="topbutton.js"></script></head><body onload="init()"><div class="topButton" id="topButton0"><a class="topButton" href="#top"><img src="image/top.gif" width="62" height="20" border="0" alt="Top" title="Top"></a></div><div class="top_header"><div class="top_header_title"><a title="Title Page" class="top_link" target="_top" HREF="index.html">Enterprise Postgres 13&nbsp;Application Development Guide</a></div><div class="top_header_graphic"><span class="top_logo"><img src="image/logo-white-fj.gif" width="148" height="32" alt=""></span><span class="top_keygraphic"><img src="image/cover-header-graphic.gif" width="148" height="32" alt="FUJITSU Software"></span></div></div><div class="header_footer"><div class="breadcrumbslist"><a href="j2681-b-00-00.html">Appendix&nbsp;B Conversion Procedures Required due to Differences from Oracle Database</a> &gt; <a href="j2681-b-07-00.html">B.7 DBMS_SQL (Execute Dynamic SQL)</a> &gt; B.7.1 Searching Using a Cursor</div><div class="back_next"><a href="j2681-b-07-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2681-c-00-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div></div><h3 id="IDapl0dN59">B.7.1 Searching Using a Cursor</h3><div class="body"><div class="textblock"><p></p></div><p class="subhead_1" id="IDapl0dN60"><span class="em">Oracle database</span></p><div class="textblock"><pre class="border">CREATE PROCEDURE search_test(h_where CLOB) AS    str_sql     CLOB;    v_cnt       INTEGER;    v_array     DBMS_SQL.VARCHAR2A;    v_cur       INTEGER;    v_smpid     INTEGER;    v_smpnm     VARCHAR2(20);    v_addbuff   VARCHAR2(20);    v_smpage    INTEGER;    errcd       INTEGER;    length      INTEGER;    ret         INTEGER;BEGIN    str_sql     := 'SELECT smpid, smpnm FROM smp_tbl WHERE ' || h_where || ' ORDER BY smpid';    v_smpid     := 0;    v_smpnm     := '';    v_smpage    := 0;    <span class="em">v_cur := DBMS_SQL.OPEN_CURSOR;</span><span class="em"> ...</span><span class="em">(1)</span>    v_cnt :=       CEIL(DBMS_LOB.GETLENGTH(str_sql)/1000);     FOR idx IN 1 .. v_cnt LOOP        v_array(idx) :=             DBMS_LOB.SUBSTR(str_sql,                            1000,                            (idx-1)*1000+1);     END LOOP;    <span class="em">DBMS_SQL.PARSE(v_cur, v_array, 1, v_cnt, FALSE, DBMS_SQL.NATIVE);</span><span class="em"> ...</span><span class="em">(2)</span>    DBMS_SQL.DEFINE_COLUMN(v_cur, 1, v_smpid);    DBMS_SQL.DEFINE_COLUMN(v_cur, 2, v_smpnm, 10);    ret := DBMS_SQL.EXECUTE(v_cur);    LOOP        v_addbuff := '';        IF DBMS_SQL.FETCH_ROWS(v_cur) = 0 THEN            EXIT;        END IF;        DBMS_OUTPUT.PUT_LINE('--------------------------------------------------------');        <span class="em">DBMS_SQL.COLUMN_VALUE(v_cur, 1, v_smpid, errcd, length);</span><span class="em"> ...</span><span class="em">(3)</span>        IF errcd = 1405 THEN ...(3)          DBMS_OUTPUT.PUT_LINE('smpid       = (NULL)');        ELSE          DBMS_OUTPUT.PUT_LINE('smpid       = ' || v_smpid);        END IF;        DBMS_SQL.COLUMN_VALUE(v_cur, 2, v_smpnm, errcd, length);        IF errcd = 1406 THEN          v_addbuff := '... [len=' || length || ']';        END IF;        IF errcd = 1405 THEN          DBMS_OUTPUT.PUT_LINE('v_smpnm     = (NULL)');        ELSE          DBMS_OUTPUT.PUT_LINE('v_smpnm     = ' || v_smpnm || v_addbuff );        END IF;DBMS_OUTPUT.PUT_LINE('--------------------------------------------------------');        DBMS_OUTPUT.NEW_LINE;    END LOOP;    <span class="em">DBMS_SQL.CLOSE_CURSOR(v_cur);</span><span class="em"> ...</span><span class="em">(4)</span>    RETURN;END;/Set serveroutput oncall search_test('smpid &lt; 100');</pre></div><p class="subhead_1" id="IDapl0dN61"><span class="em">FUJITSU Enterprise Postgres</span></p><div class="textblock"><pre class="border">CREATE FUNCTION search_test(h_where text) RETURNS void AS $$DECLARE    str_sql     text;    v_cur       INTEGER;    v_smpid     INTEGER;    v_smpnm     VARCHAR(20);    v_addbuff   VARCHAR(20);    v_smpage    INTEGER;    errcd       INTEGER;    length      INTEGER;    ret         INTEGER;BEGIN    PERFORM DBMS_OUTPUT.SERVEROUTPUT(TRUE);    str_sql     := 'SELECT smpid, smpnm FROM smp_tbl WHERE ' || h_where || ' ORDER BY smpid';    v_smpid     := 0;    v_smpnm     := '';    v_smpage    := 0;    <span class="em">v_cur := DBMS_SQL.OPEN_CURSOR();</span><span class="em"> ...</span><span class="em">(1)</span>    <span class="em">PERFORM DBMS_SQL.PARSE(v_cur, str_sql, 1);</span><span class="em"> ...</span><span class="em">(2)</span>    PERFORM DBMS_SQL.DEFINE_COLUMN(v_cur, 1, v_smpid);    PERFORM DBMS_SQL.DEFINE_COLUMN(v_cur, 2, v_smpnm, 10);       ret := DBMS_SQL.EXECUTE(v_cur);    LOOP        v_addbuff := '';        IF DBMS_SQL.FETCH_ROWS(v_cur) = 0 THEN            EXIT;        END IF;        PERFORM DBMS_OUTPUT.PUT_LINE('--------------------------------------------------------');        <span class="em">SELECT value,column_error,actual_length</span>          <span class="em">INTO v_smpid, errcd, length</span>           <span class="em">FROM DBMS_SQL.COLUMN_VALUE(v_cur,</span>                                     <span class="em">1,</span>                                    <span class="em"> v_smpid);</span><span class="em"> ...</span><span class="em">(3)</span>        <span class="em">IF errcd = 22002 THEN</span><span class="em"> ...</span><span class="em">(3)</span>          PERFORM DBMS_OUTPUT.PUT_LINE('smpid       = (NULL)');        ELSE          PERFORM DBMS_OUTPUT.PUT_LINE('smpid       = ' || v_smpid);        END IF;        SELECT value,column_error,actual_length INTO v_smpnm, errcd, length FROM DBMS_SQL.COLUMN_VALUE(v_cur, 2, v_smpnm);        IF errcd = 22001 THEN          v_addbuff := '... [len=' || length || ']';        END IF;        IF errcd = 22002 THEN          PERFORM DBMS_OUTPUT.PUT_LINE('v_smpnm     = (NULL)');        ELSE          PERFORM DBMS_OUTPUT.PUT_LINE('v_smpnm     = ' || v_smpnm || v_addbuff );        END IF;        PERFORM DBMS_OUTPUT.PUT_LINE('--------------------------------------------------------');        PERFORM DBMS_OUTPUT.NEW_LINE();    END LOOP;    <span class="em">v_cur := DBMS_SQL.CLOSE_CURSOR(v_cur);</span><span class="em"> ...</span><span class="em">(4)</span>    RETURN;END;$$LANGUAGE plpgsql;SELECT search_test('smpid &lt; 100');</pre><br><dl><dt class="em">(1) OPEN_CURSOR</dt><dd><p>Same as NEW_LINE in the DBMS_OUTPUT package. Refer to NEW_LINE in the DBMS_OUTPUT package for information on specification differences and conversion procedures associated with specification differences.</p><br></dd></dl><dl><dt class="em">(2) PARSE</dt><dd></dd></dl><dl><dt class="em">Specification format for Oracle database</dt><dd><p>DBMS_SQL.PARSE(<span class="i">firstArg,</span> <span class="i">secondArg</span>, <span class="i">thirdArg</span>, <span class="i">fourthArg</span>, <span class="i">fifthArg</span>)</p></dd></dl><dl><dt class="em">Feature differences</dt><dd><dl><dt class="em">Oracle database</dt><dd><p>SQL statements can be specified with string table types (VARCHAR2A type, VARCHAR2S type). Specify this for <span class="i">secondArg</span>.</p><p>DBMS_SQL.NATIVE, DBMS_SQL.V6, DBMS_SQL.V7 can be specified for processing SQL statements.</p></dd></dl><dl><dt class="em">FUJITSU Enterprise Postgres</dt><dd><p>SQL statements cannot be specified with string table types.</p><p>DBMS_SQL.NATIVE, DBMS_SQL.V6, DBMS_SQL.V7 cannot be specified for processing SQL statements.</p></dd></dl></dd></dl><dl><dt class="em">Conversion procedure</dt><dd><p>Convert using the following procedure:</p><ol><li><p>Locate the places where the keyword "DBMS_SQL.PARSE" is used in the stored procedure.</p></li><li><p>Check the data type of the SQL statement specified for <span class="i">secondArg</span> (v_array in the example).</p><ul><li><p>If the data type is either DBMS_SQL.VARCHAR2A type or DBMS_SQL.VARCHAR2S type, then it is a table type specification. Execute step 3 and continue the conversion process.</p></li><li><p>If the data type is neither DBMS_SQL.VARCHAR2A type nor DBMS_SQL.VARCHAR2S type, then it is a string specification. Execute step 7 and continue the conversion process.</p></li></ul></li><li><p>Check the SQL statement (str_sql in the example) before it was divided into DBMS_SQL.VARCHAR2A type and DBMS_SQL.VARCHAR2S type.</p></li><li><p>Delete the sequence of the processes (processes near FOR idx in the example) where SQL is divided into DBMS_SQL.VARCHAR2A type and DBMS_SQL.VARCHAR2S type.</p></li><li><p>Replace <span class="i">secondArg</span> with the SQL statement (str_sql in the example) before it is divided, that was checked in step 2.</p></li><li><p>Delete <span class="i">thirdArg</span>, <span class="i">fourthArg</span>, and <span class="i">fifthArg</span> (v_cnt, FALSE, DBMS_SQL.NATIVE, in the example).</p></li><li><p>If DBMS_SQL.NATIVE, DBMS_SQL.V6, and DBMS_SQL.V7 are specified, then replace <span class="i">thirdArg</span> with a numeric literal 1.</p><ul><li><p>If either DBMS_SQL.VARCHAR2A type or DBMS_SQL.VARCHAR2S type is used, then <span class="i">sixthArg</span> becomes relevant.</p></li><li><p>If neither DBMS_SQL.VARCHAR2A type nor DBMS_SQL.VARCHAR2S type is used, then <span class="i">thirdArg</span> becomes relevant.</p><br></li></ul></li></ol></dd></dl><dl><dt class="em">(3) COLUMN_VALUE</dt><dd></dd></dl><dl><dt class="em">Specification format for Oracle database</dt><dd><p>DBMS_SQL.COLUMN_VALUE(<span class="i">firstArg,</span> <span class="i">secondArg</span>, <span class="i">thirdArg</span>, <span class="i">fourthArg</span>, <span class="i">fifthArg</span>)</p></dd></dl><dl><dt class="em">Feature differences</dt><dd><dl><dt class="em">Oracle database</dt><dd><p>The following error codes are returned for column_error.</p><ul><li><p>1406: fetched column value was truncated</p></li><li><p>1405: fetched column value is NULL</p></li></ul></dd></dl><dl><dt class="em">FUJITSU Enterprise Postgres</dt><dd><p>The following error codes are returned for column_error.</p><ul><li><p>22001: string_data_right_truncation</p></li><li><p>22002: null_value_no_indicator_parameter</p></li></ul></dd></dl></dd></dl><dl><dt class="em">Specification differences</dt><dd><dl><dt class="em">Oracle database</dt><dd><p>Obtained values are received with variables specified for arguments.</p></dd></dl><dl><dt class="em">FUJITSU Enterprise Postgres</dt><dd><p>Since obtained values are the search results for DBMS_SQL.COLUMN_VALUE, they are received with variables specified for the INTO clause of the SELECT statement.</p></dd></dl></dd></dl><dl><dt class="em">Conversion procedure</dt><dd><p>Convert using the following procedure:</p><ol><li><p>Locate the places where the keyword "DBMS_SQL.COLUMN_VALUE" is used in the stored procedure.</p></li><li><p>Replace the DBMS_SQL.COLUMN_VALUE location called with a SELECT INTO statement.</p><ul><li><p>Check the number of arguments (v_smpid, errcd, and length in the example) specified after <span class="i">secondArg </span>(1 in the example) of DBMS_SQL.COLUMN_VALUE.</p></li><li><p>Specify "value", "column_error", and "actual_length" in the select list, according to the number of arguments checked in the previous step (for example, if only <span class="i">thirdArg</span> is specified, then specify "value" only.)</p></li><li><p>Specify <span class="i">thirdArg</span>, <span class="i">fourthArg</span>, and <span class="i">fifthArg</span> (v_smpid, errcd, length in the example) configured for DBMS_SQL.COLUMN_VALUE, for the INTO clause.</p></li><li><p>Use DBMS_SQL.COLUMN_VALUE in the FROM clause. Specify <span class="i">firstArg</span>, <span class="i">secondArg</span>, and <span class="i">thirdArg</span> (v_cur, 1, v_smpid, in the example) before modification.</p></li></ul></li><li><p>If the <span class="i">fourthArg</span> (column_error value in the example) is used, then check the location of the target variable (errcd in the example).</p></li><li><p>If a decision process is performed in the location checked, then modify the values used in the decision process as below:</p><ul><li><p>1406 to 22001</p></li><li><p>1405 to 22002</p><br></li></ul></li></ol></dd></dl><dl><dt class="em">(4) CLOSE_CURSOR</dt><dd></dd></dl><dl><dt class="em">Specification format for Oracle database</dt><dd><p>DBMS_SQL.CLOSE_CURSOR(<span class="i">firstArg</span>)</p></dd></dl><dl><dt class="em">Specification differences</dt><dd><dl><dt class="em">Oracle database</dt><dd><p>After closing, the cursor specified in <span class="i">firstArg</span> becomes NULL.</p></dd></dl><dl><dt class="em">FUJITSU Enterprise Postgres</dt><dd><p>After closing, set the cursor to NULL by assigning the return value of DBMS_SQL.CLOSE_CURSOR to it.</p></dd></dl></dd></dl><dl><dt class="em">Conversion procedure</dt><dd><p>Convert using the following procedure:</p><ol><li><p>Locate the places where the keyword "DBMS_SQL.CLOSE_CURSOR" is used in the stored procedure.</p></li><li><p>Set the cursor to NULL by assigning (:=) the return value of DBMS_SQL.CLOSE_CURSOR to it.</p><ul><li><p>On the left-hand side, specify the argument (v_cur in the example) specified for DBMS_SQL.CLOSE_CURSOR.</p></li><li><p>Use DBMS_SQL.CLOSE_CURSOR in the right-hand side. For the argument, specify the same value (v_cur in the example) as before modification.</p></li></ul></li></ol></dd></dl></div></div><div class="header_footer"><div class="back_next"><a href="j2681-b-07-00.html"><img src="image/back2.gif" width="65" height="27" border="0" alt="Previous" title="Previous"></a><a href="j2681-c-00-00.html"><img src="image/next2.gif" width="64" height="27" border="0" alt="Next" title="Next"></a></div><div class="copyright">Copyright 2015-2021 FUJITSU LIMITED</div></div></body></html>